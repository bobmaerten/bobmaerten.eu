<!DOCTYPE html><html lang=fr><head><title>Mise en place de Virtualbox et Vagrant</title><meta charset=UTF-8 /><meta content="Blog de Bob Maerten ou y sont exposés en vrac, humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités." name=description /><meta content="width=device-width, initial-scale=1" name=viewport /><meta content="Bob Maerten" property="dc:creator"/><meta content="text/html" property="dc:format"/><meta content=fr-FR property="dc:language"/><meta content="Bob Maerten — Blog Perso" property="og:site_name"/><meta content=website property="og:type"/><meta content="https://bobmaerten.eu" property="og:url"/><meta content="Mise en place de Virtualbox et Vagrant" property="og:title"/><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" property="og:description"/><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" property="og:image"/><meta content="50.348923;3.488592" name="geo.position"/><meta content="Valenciennes, Nord" name="geo.placename"/><meta content=FR-59 name="geo.region"/><meta content="@bobmaerten" name="twitter:site"/><meta content="Mise en place de Virtualbox et Vagrant" name="twitter:title"/><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" name="twitter:description"/><meta content=summary_large_image name="twitter:card"/><meta content="https://bobmaerten.eu/img/mba2-80a22042.jpg" name="twitter:image:src"/><meta content="@bobmaerten" name="twitter:creator"/><meta content="Mise en place de Virtualbox et Vagrant" itemprop=name /><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" itemprop=description /><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" itemprop=image /><link href="https://plus.google.com/+BobMaerten" rel=publisher /><link href="/atom.xml" rel=alternate title="Bob Maerten — Blog Perso" type="application/rss+xml"/><meta content=yes name=mobile-web-app-capable /><meta content="Bob Maerten — Blog Perso" name=application-name /><link href="/chrome-touch-icon-192x192.png" rel=icon sizes=192x192 /><meta content=yes name=apple-mobile-web-app-capable /><meta content=black name=apple-mobile-web-app-status-bar-style /><meta content="Bob Maerten — Blog Perso" name=apple-mobile-web-app-title /><link href="/apple-touch-icon.png" rel=apple-touch-icon /><meta content="ms-touch-icon-144x144-precomposed.png" name=msapplication-TileImage /><meta content="#F5F5F5" name=msapplication-TileColor /><meta content="#F5F5F5" name=theme-color /><link href="/favicon-196x196.png" rel=icon sizes=196x196 type="image/png"/><link href="/favicon-160x160.png" rel=icon sizes=160x160 type="image/png"/><link href="/favicon-96x96.png" rel=icon sizes=96x96 type="image/png"/><link href="/favicon-32x32.png" rel=icon sizes=32x32 type="image/png"/><link href="/favicon-16x16.png" rel=icon sizes=16x16 type="image/png"/><link href="../css/main-cf73b3e5.css" rel=stylesheet /></head><body id=top><header id=header><a class="image avatar" href="/"><img srcset="../img/avatar2014_2x-09ee3761.jpg 2x" alt="Photo de Bob Maerten" src="../img/avatar2014-89449806.jpg"/></a><h1><strong>Bob Maerten</strong><br/> Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités. </h1><ul class=nav><li><a href="../about.html">À propos</a></li><li><a href="./">Blog</a></li></ul></header><div id=main><section id=post><header class=major><h2 class=post-title>Mise en place de Virtualbox et Vagrant</h2></header><div class="image fit"><img srcset="../img/mba2_2x-382c9230.jpg 2x" alt=mba2 src="../img/mba2-80a22042.jpg"/></div><p class=post-meta><span>16 Jul 2012</span><br/><span><a class="post-category post-category-dev" href="tags/dev.html">dev</a></span><span><a class="post-category post-category-sysadm" href="tags/sysadm.html">sysadm</a></span></p><div class=post-description><p><p>Lorsqu&#39;il s&#39;agit de tester une application ou une configuration, vient toujours le moment ou on se demande si cela vraiment fonctionner « en vrai », dans la mesure ou bien souvent, on effectue qu&#39;une partie des tests en question afin de ne pas casser complètement son environnement de tests et donc d&#39;avoir à le reconstruire à chaque fois.</p> <p>Et si on avait le luxe de pouvoir casser cet environnement de test aussi souvent qu&#39;on le voulait, sans se soucier d&#39;avoir à péniblement le reconstruire ? La donne serait-elle différente et nos tests plus fréquents ou plus complets ?</p> <p>C&#39;est que ce je vous propose de regarder avec Virtualbox+Vagrant.</p> <h2>Introduction</h2> <p><img alt="virtualbox logo" src="http://www.prodigyproductionsllc.com/wp-content/uploads/2011/05/virtualbox_logo.png"/> <a href="http://virtualbox.org">Virtualbox</a> est une solution de virtualisation de machine. Disponible sur la plupart des plate-formes du marché, il permet d&#39;installer et de faire tourner différents systèmes en émulant le fonctionnement des périphériques (CPU, Mémoire, Disques, USB, etc.). L&#39;intérêt dans notre cas, est que le disque du système dit « invité » est géré physiquement par un fichier sur le système « hôte », ce qui permet de le manipuler à loisir pour copier une machine virtuellement, la sauvegarder, la distribuer, ou s&#39;en servir de référence.</p> <p><img alt=hippie src="http://vagrantup.com/static/images/hippie.png"/> Toutes les manipulations que l&#39;on peut faire via l&#39;interface utilisateur de Virtualbox étant disponible sous forme « d&#39;API », il devient possible de scripter un certain nombre d&#39;actions. C&#39;est là que <a href="http://vagrantup.com">Vagrant</a> entre en scène. C&#39;est un logiciel développé en ruby, distribué <a href="http://rubygems.org">sous forme de gem</a> pour les systèmes *nix, et <a href="http://vagrantup.com">sous forme de package</a> sous Windows, qui permet la manipulation d&#39;image systèmes crées pour Virtualbox : création à partir d&#39;une référence, démarrage, configuration, provisionnement, arrêt et suppression.</p> <p><img alt="Puppet Logo" src="http://www.noxlogic.nl/wp-content/uploads/2012/04/Puppet_Logo.png"/> <img alt="Chef Logo" src="http://wiki.opscode.com/download/attachments/688131/OC_Chef_Logo_small.png"/> Arrêtons-nous un moment sur une des fonctions citées : <em>provisionnement</em>. C&#39;est là la vraie raison de l&#39;utilisation du couple Virtualbox+Vagrant. En effet, Vagrant permet de préciser un état de configuration à la machine lancée, grâce à des outils comme <a href="ihttp://wiki.opscode.com/display/chef/Home">Chef</a> ou <a href="http://puppetlabs.com">Puppet</a>, de telle sorte qu&#39;au lieu de préparer un environnement « à la main », il convient de prendre un peu plus de temps à le préparer de manière automatisée et de pouvoir réinitialiser la machine virtuelle pour retrouver un environnement nominal. Je ne vais pas trop insister sur les techniques liées aux deux outils de provisionnement proposé par Vagrant, mais si cette partie vous intéresse j&#39;en reparlerai plus en détails dans un prochain billet.</p> <h2>Installation des outils</h2> <p>L&#39;installation de Virtualbox est triviale. Sur les systèmes Debian, elle consiste à installer le paquet virtualbox-ose et sous Windows/Apple à télécharger l&#39;installeur pour lequel il conviendra de cliquer autant de fois que nécessaire sur le bouton &ldquo;suivant&rdquo;. :-)</p> <p>{% highlight bash %} sudo aptitude install virtualbox-ose {% endhighlight %}</p> <p>L&#39;installation de Vagrant l&#39;est tout autant pour peu que vous ayez un environnement ruby fonctionnel sur votre système *nix. À défaut d&#39;un billet de mise à jour sur mon installation ruby courante, reportez-vous à <a href="/environnement-de-developpment-rails-sous-ubuntu-11-dot-10">ce précédent billet</a>. Sous Windows, Vagrant est proposé sous forme d&#39;installateur, si bien que l&#39;environnement ruby est installé en même temps.</p> <p>{% highlight bash %} gem install vagrant &ndash;no-ri &ndash;no-rdoc {% endhighlight %}</p> <h2>Préparation/récupération d&#39;une VM de base</h2> <p>Le site de Vagrant propose un certain de nombre de <a href="https://github.com/mitchellh/vagrant/wiki/Available-Vagrant-Boxes">machines virtuelles pré-configurées</a> (dernières version de Ubuntu en 32 et 64 bits), mais également une liste de <a href="http://www.vagrantbox.es/">machines mises à dispositions par la communauté</a>. Il est bien évidemment possible de créer ses propres « baseboxes » en suivant <a href="http://vagrantup.com/v1/docs/base_boxes.html">les préconisations</a> du site ou en utilisant une gem bien utile appelée <a href="http://rubygems.org/gems/veewee">veewee</a>.</p> <p>Afin d&#39;éviter de télécharger à chaque nouvelle utilisation, Vagrant peut stocker dans votre homedir (~/vagrant.d) les <em>basebox</em> que vous manipulerez fréquemment:</p> <p>{% highlight bash %} vagrant box add precise64 http://files.vagrantup.com/precise64.box {% endhighlight %}</p> <h2>Mise en oeuvre</h2> <p>Prenons l&#39;exemple d&#39;un test sur une application web. L&#39;idée étant de ne pas avoir à installer de serveur web, ni toute la couche applicative et ses dépendances sur son environnement de travail habituel (pour ne pas le « pourrir ») d&#39;une part, et éventuellement d&#39;autre part de tester le fonctionnement de l&#39;application dans un environnement le plus proche possible de celui dans lequel il sera ammené à fonctionner lors de sa mise en production.</p> <p>Mettons que l&#39;on souhaite tester <a href="http://owncloud.org">ownCloud</a>, la page <a href="http://owncloud.org/support/install/">listant les pré-requis</a> va nous servir de base pour préparer notre configuration. Créons un dossier dans lequel nous déposerons l&#39;archive du logiciel.</p> <p>{% highlight bash %} mkdir /tmp/owncloud<em>test &amp;&amp; cd /tmp/owncloud</em>test wget http://download.owncloud.org/releases/owncloud-4.0.4.tar.bz2 {% endhighlight %}</p> <p>Pour pouvoir fonctionner, Vagrant s&#39;attend à trouver un fichier de configuration dans lequel il va nous être possible de définir en plus les quelques directives permettant de paramétrer notre environnement cible.</p> <p>{% highlight bash %} vagrant init precise64 {% endhighlight %} Une fois le ficher Vagrantfile de base créé, renseignons le un peu plus afin de configurer notre VM comme on le souhaite</p> <p>{% highlight ruby %} Vagrant::Config.run do |config|</p> <p># Basebox utilisée pour construire la VM config.vm.box = &ldquo;precise64&rdquo;</p> <p># Forward du port 8080 du système hôte vers le port 80 de la VM # afin de permettre l&#39;accès au serveur web de le VM depuis le système config.vm.forward_port 80, 8080</p> <p># Utilisation de puppet (standalone) # normalement installé par défaut sur les basebox) config.vm.provision :puppet do |puppet| puppet.manifests<em>path = &ldquo;.&rdquo; puppet.manifest</em>file = &ldquo;owncloud.pp&rdquo; end</p> <p># execution de commandes spécifiques qui ne peuvent être prises en charge par Puppet config.vm.provision :shell, :inline =&gt; &lsquo;sudo rm -rf /var/www/* &amp;&amp; cd /tmp &amp;&amp; tar -xjf /vagrant/owncloud-4.0.4.tar.bz2 &amp;&amp; sudo mv /tmp/owncloud/* /var/www/ &amp;&amp; chown -R www-data: /var/www &amp;&amp; sudo apache2 restart&rsquo; end {% endhighlight %}</p> <p>{% highlight ruby %} $owncloud<em>reqs = [ &ldquo;libapache2-mod-php5&rdquo;, &ldquo;php5-json&rdquo;, &ldquo;php5-gd&rdquo;, &ldquo;php5-sqlite&rdquo;, &ldquo;curl&rdquo;, &ldquo;libcurl3&rdquo;, &ldquo;libcurl3-dev&rdquo;, &ldquo;php5-curl&rdquo;, ] package { $owncloud</em>reqs: ensure =&gt; installed, } {% endhighlight %}</p> <p>{% highlight bash %} $ vagrant up [default] Importing base box &#39;precise64&rsquo;&hellip; [default] Matching MAC address for NAT networking&hellip; [default] Clearing any previously set forwarded ports&hellip; [default] Forwarding ports&hellip; [default] &ndash; 22 =&gt; 2222 (adapter 1) [default] &ndash; 80 =&gt; 8080 (adapter 1) [default] Creating shared folders metadata&hellip; [default] Clearing any previously set network interfaces&hellip; [default] Booting VM&hellip; [default] Waiting for VM to boot. This can take a few minutes. [default] VM booted and ready for use! [default] Mounting shared folders&hellip; [default] &ndash; v-root: /vagrant [default] &ndash; manifests: /tmp/vagrant-puppet/manifests [default] Running provisioner: Vagrant::Provisioners::Puppet&hellip; [default] Running Puppet with /tmp/vagrant-puppet/manifests/owncloud.pp&hellip; notice: /Stage[main]//Package[php5-sqlite]/ensure: ensure changed &#39;purged&rsquo; to &#39;present&rsquo;</p> <p>notice: /Stage[main]//Package[php5-curl]/ensure: ensure changed &#39;purged&rsquo; to &#39;present&rsquo; notice: /Stage[main]//Package[php5-json]/ensure: ensure changed &#39;purged&rsquo; to &#39;present&rsquo; notice: /Stage[main]//Package[php5-gd]/ensure: ensure changed &#39;purged&rsquo; to &#39;present&rsquo;</p> <p>notice: /Stage[main]//Package[libcurl3-dev]/ensure: ensure changed &#39;purged&rsquo; to &#39;present&rsquo; [default] Running provisioner: Vagrant::Provisioners::Shell&hellip; {% endhighlight %}</p> <p>Une fois la main rendue (c&#39;est potentiellement <em>très</em> long, Puppet n&#39;étant pas véloce en plus du volume dess paquets à télécharger), il suffit de se connecter à http://localhost:8080 sur votre propre machine et constater le résultat. <img alt="Résultat d'installation" src="../images/vagrant/localhost_owncloud.png"/></p> <p>Et voilà, une installation « jetable » de owncloud me permettant de tester l&#39;installation, d&#39;avancer dans la configuration, et de revenir à zéro en réinialisant complètement la machine virtuelle.</p> <h2>Autres commandes</h2> <p>La commande &#39;vagrant&rsquo; permet également de stopper ou suspendre (au sens Virtualbox du terme), de redémarrer, et détruire la VM. Sous *nix, la commande &#39;vagrant ssh&rsquo; comme elle l&#39;indique permet de se connecter via SSH sur la machine virtuelle, comme on se connecterait à un serveur distant. La connexion s&#39;effectue sans mot de passe, grâce à une clé semi-privé dans le sens ou c&#39;est une clé utilisée par défaut dans toutes les installations de vagrant (il est préconisé de l&#39;utiliser à la création d&#39;une nouvelle basebox si elle a vocation à être distribuée).</p> <p>Windows étant dépourvu de client SSH natif, la commande renvoie une erreur en précisant qu&#39;il est possible d&#39;utiliser un client externe tel que <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">PuTTY</a> en convertissant la clé partagée au bon format.</p> <p>La commande &#39;vagrant provision&rsquo; relance le processus de provisionnement.</p> <h2>Conclusion</h2> <p>Vagrant est un outil très intéressant pour manipuler facilement différents environnements. Que ce soit pour effectuer des tests, valider un environnement, isoler des services/applications ou tester des directives Puppet/Chef en vue d&#39;un déploiement réel.</p> <p>L&#39;inconvénient est évidemment que, comme tout ce qui est virtualisé, c&#39;est fortement consommateur de ressources et en l&#39;occurence, pas très véloce sauf à avoir une très bonne machine. Le provisionnement à répétition peut être aussi un gouffre à temps perdu lorsque des paquets doivent être installés (ils sont re-téléchargés à chaque fois). Il peut-être intéressant dans cette situation d&#39;avoir recours à un proxy-cache. Cela fera peut-être l&#39;objet d&#39;un prochain billet&hellip;</p> <h3>Lectures complémentaires</h3> <p>L&#39;éventail des possibilités est bien évidemment plus large que le petit cas particulier étudié ici.</p> <ul> <li><p>Je ne peux que vous conseiller la lecture de <a href="http://vagrantup.com/v1/docs/index.html">la partie doc site de vagrant</a> afin d&#39;en apprendre davantage. N&#39;hésitez pas à partager vos éventuels usages de Vagrant, c&#39;est toujours intéressant de connaitres différents usages.</p></li> <li><p>Présentation de <a href="http://twitter.com/jmfontaine">@jmfontaine</a> au RMLL 2012 sur la <a href="http://www.slideshare.net/JMF/grer-ses-environnements-de-dveloppement-avec-vagrant-rmll-2012">gestion des environnements de développement avec vagrant</a></p></li> </ul> </p></div></section></div><footer id=footer><ul class=icons><li><a class="icon fa-envelope-o" href="#email-protection-uryyb@oboznregra.rh"><span class=label>Email</span></a></li><li><a class="icon fa-rss" href="/atom.xml"><span class=label>RSS</span></a></li><li><a class="icon fa-twitter" href="https://twitter.com/bobmaerten"><span class=label>Twitter</span></a></li><li><a class="icon fa-github" href="https://github.com/bobmaerten"><span class=label>Github</span></a></li></ul><ul class=copyright><li>© Bob Maerten</li><li>Design&nbsp;: <a href="http://html5up.net">HTML5 UP</a></li><li>Photo&nbsp;: <a href="http://unsplash.com/juskteez/">Juskteez Vu</a></li></ul></footer><script src="../js/all-39da47a7.js"></script><script type="text/javascript">!function(){try{var a,b,c,d,g=document.getElementsByTagName("a");for(c=0;g.length-c;c++)try{b=g[c].getAttribute("href"),b&&b.indexOf("#email-protection-")>-1&&b.length>19&&(a="",d=19+b.indexOf("#email-protection-"),b.length>d&&(a=b.substr(18).replace(/[a-zA-Z]/g,function(a){return String.fromCharCode(("Z">=a?90:122)>=(a=a.charCodeAt(0)+13)?a:a-26)})),g[c].setAttribute("href","mailto:"+a))}catch(h){}}catch(h){}}();</script>
</body></html>