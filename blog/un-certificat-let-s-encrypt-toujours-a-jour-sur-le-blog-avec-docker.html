<!DOCTYPE html><html lang=fr><head><title>Un certificat Let's Encrypt toujours à jour sur le blog avec Docker</title><meta charset=UTF-8 /><meta content="Blog de Bob Maerten ou y sont exposés en vrac, humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités." name=description /><meta content="width=device-width, initial-scale=1" name=viewport /><meta content="Bob Maerten" property="dc:creator"/><meta content="text/html" property="dc:format"/><meta content=fr-FR property="dc:language"/><meta content="Bob Maerten — Blog Perso" property="og:site_name"/><meta content=website property="og:type"/><meta content="https://bobmaerten.eu" property="og:url"/><meta content="Un certificat Let's Encrypt toujours à jour sur le blog avec Docker" property="og:title"/><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" property="og:description"/><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" property="og:image"/><meta content="50.348923;3.488592" name="geo.position"/><meta content="Valenciennes, Nord" name="geo.placename"/><meta content=FR-59 name="geo.region"/><meta content="@bobmaerten" name="twitter:site"/><meta content="Un certificat Let's Encrypt toujours à jour sur le blog avec Docker" name="twitter:title"/><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" name="twitter:description"/><meta content=summary_large_image name="twitter:card"/><meta content="https://bobmaerten.eu/img/sliders-7ff84f1b.jpg" name="twitter:image:src"/><meta content="@bobmaerten" name="twitter:creator"/><meta content="Un certificat Let's Encrypt toujours à jour sur le blog avec Docker" itemprop=name /><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" itemprop=description /><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" itemprop=image /><link href="https://plus.google.com/+BobMaerten" rel=publisher /><link href="/atom.xml" rel=alternate title="Bob Maerten — Blog Perso" type="application/rss+xml"/><meta content=yes name=mobile-web-app-capable /><meta content="Bob Maerten — Blog Perso" name=application-name /><link href="/chrome-touch-icon-192x192.png" rel=icon sizes=192x192 /><meta content=yes name=apple-mobile-web-app-capable /><meta content=black name=apple-mobile-web-app-status-bar-style /><meta content="Bob Maerten — Blog Perso" name=apple-mobile-web-app-title /><link href="/apple-touch-icon.png" rel=apple-touch-icon /><meta content="ms-touch-icon-144x144-precomposed.png" name=msapplication-TileImage /><meta content="#F5F5F5" name=msapplication-TileColor /><meta content="#F5F5F5" name=theme-color /><link href="/favicon-196x196.png" rel=icon sizes=196x196 type="image/png"/><link href="/favicon-160x160.png" rel=icon sizes=160x160 type="image/png"/><link href="/favicon-96x96.png" rel=icon sizes=96x96 type="image/png"/><link href="/favicon-32x32.png" rel=icon sizes=32x32 type="image/png"/><link href="/favicon-16x16.png" rel=icon sizes=16x16 type="image/png"/><link href="../css/main-cf73b3e5.css" rel=stylesheet /></head><body id=top><header id=header><a class="image avatar" href="/"><img srcset="../img/avatar2014_2x-09ee3761.jpg 2x" alt="Photo de Bob Maerten" src="../img/avatar2014-89449806.jpg"/></a><h1><strong>Bob Maerten</strong><br/> Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités. </h1><ul class=nav><li><a href="../about.html">À propos</a></li><li><a href="./">Blog</a></li></ul></header><div id=main><section id=post><header class=major><h2 class=post-title>Un certificat Let's Encrypt toujours à jour sur le blog avec Docker</h2></header><div class="image fit"><img srcset="../img/sliders_2x-22dd8464.jpg 2x" alt=sliders src="../img/sliders-7ff84f1b.jpg"/></div><p class=post-meta><span>27 Jan 2016</span><br/><span><a class="post-category post-category-blog" href="tags/blog.html">blog</a></span><span><a class="post-category post-category-sysadm" href="tags/sysadm.html">sysadm</a></span><span><a class="post-category post-category-linux" href="tags/linux.html">linux</a></span></p><div class=post-description><p><p>Depuis l&#39;année dernière ce blog répond exclusivement en HTTPS grâce à un certificat valide et reconnu, issu d&#39;une <a href="https://www.wosign.com">autorité de certification chinoise</a> qui propose (proposait ?) des certificats gratuits. Mais depuis, <a href="https://letsencrypt.org">Let&rsquo;s encrypt</a> est disponible en béta publique et je cherchais depuis quelques jours un moyen de l&#39;inclure dans la <em>stack</em> d&#39;hébergement de ce blog et permettre la création et le renouvellement automatique de certificat SSL, comme il est promis dans la documentation.</p> <p></p> <h2>Contexte</h2> <p>Ce blog est servi au travers de deux conteneurs Docker:</p> <ul> <li>un issu de l&#39;image officielle <a href="http://hub.docker.com/_/nginx">nginx</a> sur laquelle j&#39;y ajoute le <a href="http://github.com/bobmaerten/bobmaerten.eu">contenu statique</a> ;</li> <li>un autre exécutant l&#39;image du <a href="http://hub.docker.com/r/jwilder/nginx-proxy">reverse-proxy nginx</a> de <a href="http://jasonwilder.com/">Jason Wilder</a> permettant d&#39;uniformiser la configuration des différents sites et d&#39;aiguiller vers le bon conteneur.</li> </ul> <p>Il ne manquait plus qu&#39;un dernier conteneur qui assurerait la gestion et le suivi des certificats issus de Let&rsquo;s Encrypt. Mais j&#39;avais beau essayer d&#39;utiliser le client officiel de différente manières, il y a toujours une étape ou le client doit se substituer au serveur web réel pour répondre au challenge proposé par les serveurs de Let&rsquo;s Encrypt, afin de valider la demande de certificat.</p> <p>Heureusement, nous évoluons dans une sphère libre ! Il existe dès lors <a href="https://www.metachris.com/2015/12/comparison-of-10-acme-lets-encrypt-clients/">moultes implémentations</a> légèrement différentes du client officiel. Et c&#39;est avec l&#39;une de ces implémentations qu&rsquo;<a href="https://github.com/JrCs">Yves Blusseau</a> a eu l&#39;excellente idée d&rsquo;<a href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion">implémenter ce que je cherchais à faire</a> : un conteneur qui fait tourner un client lets-encrypt, pilotant automatiquement la configuration du reverse-proxy pour la réponse au challenge du serveur et assurant la gestion des certificats, en incluant tout cela dans la configuration de nginx.</p> <h2>Bon et techniquement, ça donne quoi ?</h2> <p>Donc voici les commandes qui me permettent de lancer la <em>stack</em> de ce blog</p> <pre class="highlight shell"><code><span class="c"># Démarrage du reverse-proxy nginx</span>
docker run --name nginx-proxy <span class="se">\</span>
  -p 80:80 -p 443:443 <span class="se">\</span>
  -v /home/bob/certs:/etc/nginx/certs:ro <span class="se">\</span>
  -v /etc/nginx/vhost.d <span class="se">\</span>
  -v /usr/share/nginx/html <span class="se">\</span>
  -v /var/run/docker.sock:/tmp/docker.sock:ro <span class="se">\</span>
  --restart<span class="o">=</span>always <span class="se">\</span>
  --detach jwilder/nginx-proxy
</code></pre> <p>Le conteneur accède au répertoire de l&#39;hôte pour les certificats ainsi que sur le socket du <em>daemon</em> Docker, car il a besoin de récupérer les metadonnées des conteneurs (notamment la variable VIRTUAL_HOST, voir ci-dessous). Deux volumes sur <code>/etc/nginx/vhost.d</code> et <code>/usr/share/nginx/html</code> sont déclarés car ils seront utilisés par le conteneur lets-encrypt.</p> <pre class="highlight shell"><code><span class="c"># Démarrage du conteneur de gestion des certificats et de la conf nginx</span>
docker run --name letsencrypt-companion <span class="se">\</span>
  -v /home/bob/certs:/etc/nginx/certs:rw <span class="se">\</span>
  --volumes-from nginx-proxy <span class="se">\</span>
  -v /var/run/docker.sock:/var/run/docker.sock:ro <span class="se">\</span>
  --restart<span class="o">=</span>always <span class="se">\</span>
  --detach jrcs/letsencrypt-nginx-proxy-companion
</code></pre> <p>Ici le répertoire des certificats est monté en écriture et il sera partagé (sur l&#39;hôte) avec le reverse-proxy. Ce conteneur utilise les volumes déclarés dans le reverse-proxy (<code>volumes-from</code>) ainsi que l&#39;accès au socket du <em>daemon</em> Docker également (pour lire les variables d&#39;environnement déclarées sur les conteneurs “client”).</p> <pre class="highlight shell"><code><span class="c"># Démarrage du conteneur du blog</span>
docker run --name bobmaerten-eu <span class="se">\</span>
   -e      <span class="nv">VIRTUAL_HOST</span><span class="o">=</span><span class="s2">"bobmaerten.eu"</span> <span class="se">\</span>
   -e  <span class="nv">LETSENCRYPT_HOST</span><span class="o">=</span><span class="s2">"bobmaerten.eu"</span> <span class="se">\</span>
   -e <span class="nv">LETSENCRYPT_EMAIL</span><span class="o">=</span><span class="s2">"hello@bobmaerten.eu"</span> <span class="se">\</span>
   --restart<span class="o">=</span>always <span class="se">\</span>
   --detach bobmaerten/bobmaerten.eu:latest
</code></pre> <p>Enfin, le conteneur qui sert le blog, ou je déclare les variables d&#39;environnement qui seront utilisées pour la configuration du reverse-proxy (VIRTUAL_HOST) et du client lets-encrypt.</p> <p>Au démarrage de la <em>stack</em>, le reverse-proxy détecte le VIRTUAL_HOST <code>bobmaerten.eu</code> et crée dynamiquement l&#39;entrée <code>server</code> dans la configuration de nginx, et le client lets-encrypt modifie également dynamiquement la configuration du reverse-proxy si un certificat est échu ou renouvelé.</p> <p>Je vous laisse le soin d&#39;aller explorer les différents dépôts respectifs à cette <em>stack</em> si vous êtes curieux du <em>comment-ça-marche-sous-le-capot</em>.</p> </p></div></section></div><footer id=footer><ul class=icons><li><a class="icon fa-envelope-o" href="#email-protection-uryyb@oboznregra.rh"><span class=label>Email</span></a></li><li><a class="icon fa-rss" href="/atom.xml"><span class=label>RSS</span></a></li><li><a class="icon fa-twitter" href="https://twitter.com/bobmaerten"><span class=label>Twitter</span></a></li><li><a class="icon fa-github" href="https://github.com/bobmaerten"><span class=label>Github</span></a></li></ul><ul class=copyright><li>© Bob Maerten</li><li>Design&nbsp;: <a href="http://html5up.net">HTML5 UP</a></li><li>Photo&nbsp;: <a href="http://unsplash.com/juskteez/">Juskteez Vu</a></li></ul></footer><script src="../js/all-39da47a7.js"></script><script type="text/javascript">!function(){try{var a,b,c,d,g=document.getElementsByTagName("a");for(c=0;g.length-c;c++)try{b=g[c].getAttribute("href"),b&&b.indexOf("#email-protection-")>-1&&b.length>19&&(a="",d=19+b.indexOf("#email-protection-"),b.length>d&&(a=b.substr(18).replace(/[a-zA-Z]/g,function(a){return String.fromCharCode(("Z">=a?90:122)>=(a=a.charCodeAt(0)+13)?a:a-26)})),g[c].setAttribute("href","mailto:"+a))}catch(h){}}catch(h){}}();</script>
</body></html>