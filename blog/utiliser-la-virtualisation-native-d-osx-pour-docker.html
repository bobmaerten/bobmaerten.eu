<!DOCTYPE html><html lang=fr><head><title>Utiliser la virtualisation native d'OSX pour Docker</title><meta charset=UTF-8 /><meta content="Blog de Bob Maerten ou y sont expos√©s en vrac, humeurs, interrogations, p√¢tisseries, d√©veloppement web, syst√®mes Linux et autres curiosit√©s." name=description /><meta content="width=device-width, initial-scale=1" name=viewport /><meta content="Bob Maerten" property="dc:creator"/><meta content="text/html" property="dc:format"/><meta content=fr-FR property="dc:language"/><meta content="Bob Maerten ‚Äî Blog Perso" property="og:site_name"/><meta content=website property="og:type"/><meta content="https://bobmaerten.eu" property="og:url"/><meta content="Utiliser la virtualisation native d'OSX pour Docker" property="og:title"/><meta content="Humeurs, interrogations, p√¢tisseries, d√©veloppement web, syst√®mes Linux et autres curiosit√©s" property="og:description"/><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" property="og:image"/><meta content="50.348923;3.488592" name="geo.position"/><meta content="Valenciennes, Nord" name="geo.placename"/><meta content=FR-59 name="geo.region"/><meta content="@bobmaerten" name="twitter:site"/><meta content="Utiliser la virtualisation native d'OSX pour Docker" name="twitter:title"/><meta content="Humeurs, interrogations, p√¢tisseries, d√©veloppement web, syst√®mes Linux et autres curiosit√©s" name="twitter:description"/><meta content=summary_large_image name="twitter:card"/><meta content="https://bobmaerten.eu/img/book-55aa08e6.jpg" name="twitter:image:src"/><meta content="@bobmaerten" name="twitter:creator"/><meta content="Utiliser la virtualisation native d'OSX pour Docker" itemprop=name /><meta content="Humeurs, interrogations, p√¢tisseries, d√©veloppement web, syst√®mes Linux et autres curiosit√©s" itemprop=description /><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" itemprop=image /><link href="https://plus.google.com/+BobMaerten" rel=publisher /><link href="/atom.xml" rel=alternate title="Bob Maerten ‚Äî Blog Perso" type="application/rss+xml"/><meta content=yes name=mobile-web-app-capable /><meta content="Bob Maerten ‚Äî Blog Perso" name=application-name /><link href="/chrome-touch-icon-192x192.png" rel=icon sizes=192x192 /><meta content=yes name=apple-mobile-web-app-capable /><meta content=black name=apple-mobile-web-app-status-bar-style /><meta content="Bob Maerten ‚Äî Blog Perso" name=apple-mobile-web-app-title /><link href="/apple-touch-icon.png" rel=apple-touch-icon /><meta content="ms-touch-icon-144x144-precomposed.png" name=msapplication-TileImage /><meta content="#F5F5F5" name=msapplication-TileColor /><meta content="#F5F5F5" name=theme-color /><link href="/favicon-196x196.png" rel=icon sizes=196x196 type="image/png"/><link href="/favicon-160x160.png" rel=icon sizes=160x160 type="image/png"/><link href="/favicon-96x96.png" rel=icon sizes=96x96 type="image/png"/><link href="/favicon-32x32.png" rel=icon sizes=32x32 type="image/png"/><link href="/favicon-16x16.png" rel=icon sizes=16x16 type="image/png"/><link href="../css/main-8e11d2a2.css" rel=stylesheet /></head><body id=top><header id=header><a class="image avatar" href="/"><img srcset="../img/avatar2014_2x-09ee3761.jpg 2x" alt="Photo de Bob Maerten" src="../img/avatar2014-89449806.jpg"/></a><h1><strong>Bob Maerten</strong><br/> Humeurs, interrogations, p√¢tisseries, d√©veloppement web, syst√®mes Linux et autres curiosit√©s. </h1><ul class=nav><li><a href="../about.html">√Ä propos</a></li><li><a href="./">Blog</a></li></ul></header><div id=main><section id=post><header class=major><h2 class=post-title>Utiliser la virtualisation native d'OSX pour Docker</h2></header><div class="image fit"><img srcset="../img/book_2x-e370a978.jpg 2x" alt=book src="../img/book-55aa08e6.jpg"/></div><p class=post-meta><span>23 Jan 2016</span><br/><span><a class="post-category post-category-sysadm" href="tags/sysadm.html">sysadm</a></span><span><a class="post-category post-category-dev" href="tags/dev.html">dev</a></span><span><a class="post-category post-category-osx" href="tags/osx.html">osx</a></span></p><div class=post-description><p><p>Docker est un outil linux natif et pour l&#39;utiliser sous OSX (ou Windows) il faut passer par une machine virtuelle sous linux pour faire tourner le <em>daemon</em>.</p> <p>Pour cela, la pratique courante est d&#39;installer un hyperviseur (habituellement Virtualbox) afin de faire tourner <code>boot2docker</code>, la micro-VM fournie par Docker afin de l&#39;utiliser sous un autre syst√®me. Mais il est d√©sormais possible de s&#39;en passer sous OSX.</p> <p></p> <h2>Hypervisor.framework</h2> <p>La version 10.10 (Yosemite) d&#39;OSX a introduit un syst√®me de virtualisation natif en mode utilisateur et permet l&#39;utilisation directe des instructions VT-x des processeurs Intel. Cela permet donc de virtualiser des applications, sans extension du noyau.</p> <p>D&#39;ailleurs, <a href="http://veertu.com/">Veertu</a>, r√©cemment publi√© sur l&#39;app store permet d&#39;installer des VMs en utilisant l&#39;hyperviseur natif d&#39;OSX, explique bien cette diff√©rence.</p> <p><img alt="Legacy Virt" src="http://veertu.com/test/wp-content/uploads/2015/10/legacy.svg"/> <img alt="OSX Virt" src="http://veertu.com/test/wp-content/uploads/2015/10/new.svg"/></p> <p>Bien que Veertu propose l&rsquo;<a href="https://twitter.com/veertu_labs/status/687552097869533184">installation de boot2docker</a> ce n&#39;est pas de ce syst√®me dont je vais vous parler.</p> <h2>Xhyve et son driver docker-machine</h2> <p><a href="https://github.com/mist64/xhyve">Xhyve</a> s&#39;appuie √©galement sur l&rsquo;<em>hypervisor.framework</em> d&#39;OSX et permet de virtualiser des syst√®mes linux et BSD tout comme il √©tait possible de le faire avec Virtualbox, mais sans la lourdeur d&#39;Oracle. Son installation est on ne peut plus simple d√®s lors que <em>homebrew</em> est install√© (<em>t&#39;es un dev sous mac et t&#39;as pas homebrew install√©, nan mais all&hellip;</em> üò¨) : <code>brew install xhyve</code>.</p> <p>Mais l√† ou cela devient int√©ressant, c&#39;est qu&#39;il existe d√©sormais un <a href="https://github.com/zchee/docker-machine-driver-xhyve">driver xhyve pour docker-machine</a> (celui de Virtualbox est utilis√© par d√©faut si on n&#39;en pr√©cise pas). L&#39;installer est tout aussi simple : <code>brew install docker-machine-driver-xhyve</code>.</p> <p>Cela dit, je vous recommande chaudement de tout installer avec homebrew. J&#39;avais des restes d&#39;installation de <strong>docker-toolbox</strong> et la cr√©ation de la VM n&#39;a pas fonctionn√©. Le mieux est donc de supprimer les binaires et de les r√©installer avec homebrew :</p> <pre class="highlight plaintext"><code>brew install xhyve docker docker-machine docker-compose docker-machine-driver-xhyve
</code></pre> <p>Au jour de r√©daction de ce billet, voici les versions install√©es suite √† cette commande :</p> <ul> <li>xhyve-0.2.0</li> <li>docker-1.9.1_1</li> <li>docker-machine-0.5.6_1</li> <li>docker-compose-1.5.2</li> <li>docker-machine-driver-xhyve-0.2.1</li> </ul> <h2>Cr√©ation et d√©marrage de la VM</h2> <p>Pour installer et d√©marrer la VM docker, il suffit d&#39;utiliser docker-machine avec le driver xhyve.</p> <pre class="highlight plaintext"><code>$ docker-machine create dockerhost --driver xhyve
Running pre-create checks...
Creating machine...
(dockerhost) Copying /Users/bob/.docker/machine/cache/boot2docker.iso to /Users/bob/.docker/machine/machines/dockerhost/boot2docker.iso...
(dockerhost) Creating VM...
(dockerhost) Extracting vmlinuz64 and initrd.img from boot2docker.iso...
(dockerhost) /dev/disk2                                                 /Users/bob/.docker/machine/machines/dockerhost/b2d-image
(dockerhost) "disk2" unmounted.
(dockerhost) "disk2" ejected.
(dockerhost) Generating 20000MB disk image...
(dockerhost) created: /Users/bob/.docker/machine/machines/dockerhost/root-volume.sparsebundle
(dockerhost) Creating SSH key...
(dockerhost) Fix file permission...
(dockerhost) Generate UUID...
(dockerhost) Convert UUID to MAC address...
(dockerhost) Starting dockerhost...
(dockerhost) Waiting for VM to come online...
(dockerhost) Waiting on a pseudo-terminal to be ready... done
(dockerhost) Hook up your terminal emulator to /dev/ttys004 in order to connect to your VM
Waiting for machine to be running, this may take a few minutes...
(dockerhost) Getting to VM state...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Detecting the provisioner...
Provisioning with boot2docker...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Checking connection to Docker...
Docker is up and running!
To see how to connect Docker to this machine, run: docker-machine env dockerhost
</code></pre> <p>Il suffit ensuite de raccrocher l&#39;environnement local √† la nouvelle VM docker :</p> <pre class="highlight plaintext"><code>$ eval "$(docker-machine env dockerhost)"
$ docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
$ docker run --rm busybox echo 'plop!
latest: Pulling from library/busybox
583635769552: Pull complete
b175bcb79023: Pull complete
Digest: sha256:c1bc9b4bffe665bf014a305cc6cf3bca0e6effeb69d681d7a208ce741dad58e0
Status: Downloaded newer image for busybox:latest
plop!
</code></pre> <p>Et voil√†, vous pouvez effacer votre stack Virtualbox ! Bon, peut-√™tre pas tout de suite car ceci est encore plut√¥t exp√©rimental, aussi je vais √©prouver la solution dans les jours/semaines qui viennent, et ce sera l&#39;occasion d&#39;un prochain billet pour √©valauer les performances et la fiabilit√© de la <em>stack</em>.</p> <h3>Edit du 25/01/2016</h3> <ul> <li>La source de cet essai est un blog post d&rsquo;<a href="https://allysonjulian.com/setting-up-docker-with-xhyve/">Allyson Julian</a></li> <li>Si vous voulez utiliser des volumes partag√©s avec l&#39;h√¥te (pas la VM, mais bien l&#39;h√¥te OSX), il faut ajouter √† l&#39;installation de la VM le flag <code>--xhyve-experimental-nfs-share</code>, sinon √ßa ne fonctionne pas.</li> </ul> <p>Bon <em>hacking</em> !</p> </p></div></section><section id=comments><h2>Commentaires</h2><div aria-live=polite id=juvia_thread><noscript>Please enable JavaScript to view the comments powered by Juvia.</noscript></div></section></div><footer id=footer><ul class=icons><li><a class="icon fa-envelope-o" href="#email-protection-uryyb@oboznregra.rh"><span class=label>Email</span></a></li><li><a class="icon fa-rss" href="/atom.xml"><span class=label>RSS</span></a></li><li><a class="icon fa-twitter" href="https://twitter.com/bobmaerten"><span class=label>Twitter</span></a></li><li><a class="icon fa-github" href="https://github.com/bobmaerten"><span class=label>Github</span></a></li></ul><ul class=copyright><li>¬© Bob Maerten</li><li>Design&nbsp;: <a href="http://html5up.net">HTML5 UP</a></li><li>Photo&nbsp;: <a href="http://unsplash.com/juskteez/">Juskteez Vu</a></li></ul></footer><script src="../js/all-39da47a7.js"></script><script src="../js/juvia-10e4cb99.js"></script><script type="text/javascript">!function(){try{var a,b,c,d,g=document.getElementsByTagName("a");for(c=0;g.length-c;c++)try{b=g[c].getAttribute("href"),b&&b.indexOf("#email-protection-")>-1&&b.length>19&&(a="",d=19+b.indexOf("#email-protection-"),b.length>d&&(a=b.substr(18).replace(/[a-zA-Z]/g,function(a){return String.fromCharCode(("Z">=a?90:122)>=(a=a.charCodeAt(0)+13)?a:a-26)})),g[c].setAttribute("href","mailto:"+a))}catch(h){}}catch(h){}}();</script>
</body></html>