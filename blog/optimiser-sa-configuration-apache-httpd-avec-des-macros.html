<!DOCTYPE html><html lang=fr><head><link href="http://gmpg.org/xfn/11" rel=profile /><meta charset=UTF-8 /><meta content="IE=edge" http-equiv=X-UA-Compatible /><meta content="text/html; charset=utf-8" http-equiv=content-type /><meta content="width=device-width, initial-scale=1.0, maximum-scale=1" name=viewport /><meta content="Blog de Bob Maerten ou y sont exposés en vrac, humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités." name=description /><title>Optimiser sa configuration Apache/httpd avec des macros · Bob Maerten</title><meta content="Bob Maerten" property="dc:creator"/><meta content="text/html" property="dc:format"/><meta content=fr-FR property="dc:language"/><meta content="Bob Maerten" property="og:site_name"/><meta content=website property="og:type"/><meta content="https://bobmaerten.eu" property="og:url"/><meta content="Optimiser sa configuration Apache/httpd avec des macros" property="og:title"/><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" property="og:description"/><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" property="og:image"/><meta content="50.348923;3.488592" name="geo.position"/><meta content="Valenciennes, Nord" name="geo.placename"/><meta content=FR-59 name="geo.region"/><meta content="@bobmaerten" name="twitter:site"/><meta content="Optimiser sa configuration Apache/httpd avec des macros" name="twitter:title"/><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" name="twitter:description"/><meta content=summary_large_image name="twitter:card"/><meta content="https://bobmaerten.eu/img/cabs-2d307157.jpg" name="twitter:image:src"/><meta content="@bobmaerten" name="twitter:creator"/><meta content="Optimiser sa configuration Apache/httpd avec des macros" itemprop=name /><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" itemprop=description /><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" itemprop=image /><link href="https://plus.google.com/+BobMaerten" rel=publisher /><link href="/atom.xml" rel=alternate title="Bob Maerten" type="application/rss+xml"/><meta content=yes name=mobile-web-app-capable /><meta content="Bob Maerten" name=application-name /><link href="/chrome-touch-icon-192x192.png" rel=icon sizes=192x192 /><meta content=yes name=apple-mobile-web-app-capable /><meta content=black name=apple-mobile-web-app-status-bar-style /><meta content="Bob Maerten" name=apple-mobile-web-app-title /><link href="/apple-touch-icon.png" rel=apple-touch-icon /><meta content="ms-touch-icon-144x144-precomposed.png" name=msapplication-TileImage /><meta content="#F5F5F5" name=msapplication-TileColor /><meta content="#F5F5F5" name=theme-color /><link href="/favicon-196x196.png" rel=icon sizes=196x196 type="image/png"/><link href="/favicon-160x160.png" rel=icon sizes=160x160 type="image/png"/><link href="/favicon-96x96.png" rel=icon sizes=96x96 type="image/png"/><link href="/favicon-32x32.png" rel=icon sizes=32x32 type="image/png"/><link href="/favicon-16x16.png" rel=icon sizes=16x16 type="image/png"/><link href="/favicon.ico" rel="shortcut icon"/><link href="../css/poole-812330fe.css" rel=stylesheet /><link href="../css/syntax-79e04e9e.css" rel=stylesheet /><link href="../css/lanyon-7e4dec9c.css" rel=stylesheet /><link href="../css/bobmaerten-42491b32.css" rel=stylesheet /><link href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400" rel=stylesheet /><link href="/atom.xml" rel=alternate title=RSS type="application/rss+xml"/></head></html><body><input class=sidebar-checkbox id=sidebar-checkbox type=checkbox /><div class=sidebar id=sidebar><div class=sidebar-item><a class="image avatar" href="/"><img srcset="../img/avatar2014_2x-09ee3761.jpg 2x" alt="Photo de Bob Maerten" src="../img/avatar2014-89449806.jpg"/></a><p>Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités</p></div><nav class=sidebar-nav><a class=sidebar-nav-item href="/about/">À propos</a><a class=sidebar-nav-item href="/">Blog</a><a class=sidebar-nav-item href="/blog/archives/">Archives</a><a class=sidebar-nav-item href="/blog/tags/">Catégories</a><a class=sidebar>-nav-item href=data.settings.social.twitter.url = data.settings.social.twitter.name</a><a class=sidebar-nav-item href="https://github.com/bobmaerten">GitHub</a><a class=sidebar-nav-item href="#email-protection-uryyb@oboznregra.rh">E-mail</a></nav><div class=sidebar-item><p>Theme <a href="http://lanyon.getpoole.com/">Lanyon </a>made by <a href="https://twitter.com/mdo"><b>@mdo</b></a></p><p>Bob Maerten / 2012 - 2016.</p></div></div><div class=wrap><div class=masthead><div class=container><h3 class=masthead-title><a href="/" title=Accueil>Bob Maerten</a> <small>Blog perso</small></h3></div></div><div class="container content"><div class=post><span class=post-date><span>29 Avril 2014</span> — <span class="post-category post-category-sysadm"><a href="tags/sysadm.html">sysadm</a></span> <span class="post-category post-category-debian"><a href="tags/debian.html">debian</a></span> </span><h1 class=post-title>Optimiser sa configuration Apache/httpd avec des macros</h1><p>Depuis quelques temps, nous avons pris l&#39;habitude au bureau d&#39;installer systématiquement toutes nos applications web derrière un <em>&lsquo;reverse proxy&rsquo;</em>. Cela permet de gagner en souplesse par le fait de déclarer dans notre DNS une adresse générique pour l&#39;application et de pouvoir gérer facilement en aval l&#39;emplacement de l&#39;application sur tel ou tel serveur, gérer la maintenance, ou encore établir une répartition de charge si le besoin s&#39;en fait sentir.</p> <p>Ce n&#39;est pas de cela que je voulais vous parler (quoique ça pourrait faire l&#39;objet d&#39;un autre billet), mais c&#39;est pour situer un peu le contexte. Je voulais préciser cela car pour ce faire jusqu&#39;alors, en bon sysadmin fainéant je faisais une copie d&#39;un fichier de référence, puis activais le <em>&#39;vhost&rsquo;</em> par un classique <code>a2ensite nouveau-reverse-proxy</code> puis rechargeait la configuration apache via <code>service apache2 reload</code>.</p> <p>Worklfow tout à fait classique, mais au combien répétitif (chose qu&#39;on déteste, nous les sysadmins) et potentiellement source d&#39;encore plus de travail si jamais on doit intervenir sur la configuration générale : repasser sur tous les fichiers de déclaration de vhosts. /o\</p> <p>C&#39;est alors que mon collègue me parle du module Macro de Apache/httpd. Disponible dans la documentation officielle à partir de la version 2.4 du serveur web, il est cependant disponible en tant que module tiers (et dispo dans les dépôts Debian depuis belle lurette) pour les version antérieurs (dont la 2.2 version officielle de la Debian stable courante). Son installation sous wheezy est on ne peut plus simple d&#39;ailleurs :</p> <pre class="highlight plaintext"><code>sudo apt-get install libapache2-mod-macro
sudo a2enmod macro
</code></pre> <p>Dès lors, il est possible d&#39;utiliser la déclaration de macro dans la configuration de Apache/httpd.</p> <p>Une macro se définit avec la déclaration <code>&lt;Macro&gt;&lt;/Macro&gt;</code> et permet donc d&#39;insérer le texte saisi entre les tags à l&#39;aide de la directive <code>Use</code>. Voici un exemple très basique dans lequel nous allons remplacer une déclaration courante de configuration :</p> <pre class="highlight plaintext"><code>&lt;Macro LocationOptions&gt;
AllowOverride All
Order deny,allow
Deny from all
Allow from 127.0.0.1 ::1
&lt;/Macro&gt;

&lt;Location /private&gt;
    Use LocationOptions
&lt;Location&gt;
&lt;Location /alsoprivate&gt;
    Use LocationOptions
&lt;Location&gt;
</code></pre> <p>Cet exemple montre qu&#39;il est possible de factoriser des élements de configuration souvent utilisés. Cependant, le plus intéressant est d&#39;utiliser les macros avec des paramètres, ci-dessous je reprends l&#39;exemple précédent afin d&#39;utiliser un paramètre pour le &#39;Allow from&rsquo; :</p> <pre class="highlight plaintext"><code>&lt;Macro LocationOptions $allowfrom&gt;
AllowOverride All
Order deny,allow
Deny from all
Allow from $allowfrom
&lt;/Macro&gt;

&lt;Location /localonly&gt;
    Use LocationOptions '127.0.0.1 ::1'
&lt;Location&gt;
&lt;Location /networkprivate&gt;
    Use LocationOptions '192.168.1.0/24'
&lt;Location&gt;
</code></pre> <p>On imagine tout de suite tout ce qu&#39;on peut gagner à utiliser des macro. Toutefois, il faut faire avec les restrictions du module, à savoir qu&#39;il n&#39;est pas possible de déclarer des macros avec un nombre de paramètres variables, ni encore de surcharger le nom d&#39;une macro. On se retrouve doncassez vite avec un nombre conséquent de macro pour gérer les différents cas possible. Voir dans le gist suivant l exemple de <a href="https://gist.github.com/bobmaerten/11393514">la configuration de nos <em>&#39;reverse-proxies&rsquo;</em></a>.</p> <p>Voilà donc comment je configure un nouveau reverse proxy désormais : une ligne à ajouter dans le fichier de configuration par défaut de Apache/httpd et un <code>service apache2 reload</code>. Les plus futés auront flairé tout de suite ou je voulais en venir dès le début : un playbook Ansible ! Mais ce sera pour un autre billet. ;-)</p> </div></div></div><label class=sidebar-toggle for=sidebar-checkbox></label><script>(function(document) { var toggle = document.querySelector('.sidebar-toggle'); var sidebar = document.querySelector('#sidebar'); var checkbox = document.querySelector('#sidebar-checkbox'); document.addEventListener('click', function(e) { var target = e.target; if(!checkbox.checked || sidebar.contains(target) || (target === checkbox || target === toggle)) return; checkbox.checked = false; }, false); })(document); </script><script type="text/javascript">!function(){try{var a,b,c,d,g=document.getElementsByTagName("a");for(c=0;g.length-c;c++)try{b=g[c].getAttribute("href"),b&&b.indexOf("#email-protection-")>-1&&b.length>19&&(a="",d=19+b.indexOf("#email-protection-"),b.length>d&&(a=b.substr(18).replace(/[a-zA-Z]/g,function(a){return String.fromCharCode(("Z">=a?90:122)>=(a=a.charCodeAt(0)+13)?a:a-26)})),g[c].setAttribute("href","mailto:"+a))}catch(h){}}catch(h){}}();</script>
</body>