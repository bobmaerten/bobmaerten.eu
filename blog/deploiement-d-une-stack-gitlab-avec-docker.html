<!DOCTYPE html><html lang=fr><head><title>Installation d'une stack gitlab avec Docker</title><meta charset=UTF-8 /><meta content="Blog de Bob Maerten ou y sont exposés en vrac, humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités." name=description /><meta content="width=device-width, initial-scale=1" name=viewport /><meta content="Bob Maerten" property="dc:creator"/><meta content="text/html" property="dc:format"/><meta content=fr-FR property="dc:language"/><meta content="Bob Maerten — Blog Perso" property="og:site_name"/><meta content=website property="og:type"/><meta content="https://bobmaerten.eu" property="og:url"/><meta content="Installation d'une stack gitlab avec Docker" property="og:title"/><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" property="og:description"/><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" property="og:image"/><meta content="50.348923;3.488592" name="geo.position"/><meta content="Valenciennes, Nord" name="geo.placename"/><meta content=FR-59 name="geo.region"/><meta content="@bobmaerten" name="twitter:site"/><meta content="Installation d'une stack gitlab avec Docker" name="twitter:title"/><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" name="twitter:description"/><meta content=summary_large_image name="twitter:card"/><meta content="https://bobmaerten.eu/img/road-941fc721.jpg" name="twitter:image:src"/><meta content="@bobmaerten" name="twitter:creator"/><meta content="Installation d'une stack gitlab avec Docker" itemprop=name /><meta content="Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités" itemprop=description /><meta content="https://bobmaerten.eu/img/avatar2014-89449806.jpg" itemprop=image /><link href="https://plus.google.com/+BobMaerten" rel=publisher /><link href="/atom.xml" rel=alternate title="Bob Maerten — Blog Perso" type="application/rss+xml"/><meta content=yes name=mobile-web-app-capable /><meta content="Bob Maerten — Blog Perso" name=application-name /><link href="/chrome-touch-icon-192x192.png" rel=icon sizes=192x192 /><meta content=yes name=apple-mobile-web-app-capable /><meta content=black name=apple-mobile-web-app-status-bar-style /><meta content="Bob Maerten — Blog Perso" name=apple-mobile-web-app-title /><link href="/apple-touch-icon.png" rel=apple-touch-icon /><meta content="ms-touch-icon-144x144-precomposed.png" name=msapplication-TileImage /><meta content="#F5F5F5" name=msapplication-TileColor /><meta content="#F5F5F5" name=theme-color /><link href="/favicon-196x196.png" rel=icon sizes=196x196 type="image/png"/><link href="/favicon-160x160.png" rel=icon sizes=160x160 type="image/png"/><link href="/favicon-96x96.png" rel=icon sizes=96x96 type="image/png"/><link href="/favicon-32x32.png" rel=icon sizes=32x32 type="image/png"/><link href="/favicon-16x16.png" rel=icon sizes=16x16 type="image/png"/><link href="../css/main-8e11d2a2.css" rel=stylesheet /></head><body id=top><header id=header><a class="image avatar" href="/"><img srcset="../img/avatar2014_2x-09ee3761.jpg 2x" alt="Photo de Bob Maerten" src="../img/avatar2014-89449806.jpg"/></a><h1><strong>Bob Maerten</strong><br/> Humeurs, interrogations, pâtisseries, développement web, systèmes Linux et autres curiosités. </h1><ul class=nav><li><a href="../about.html">À propos</a></li><li><a href="./">Blog</a></li></ul></header><div id=main><section id=post><header class=major><h2 class=post-title>Installation d'une stack gitlab avec Docker</h2></header><div class="image fit"><img srcset="../img/road_2x-381c46a0.jpg 2x" alt=road src="../img/road-941fc721.jpg"/></div><p class=post-meta><span> 8 Jan 2015</span><br/><span><a class="post-category post-category-sysadm" href="tags/sysadm.html">sysadm</a></span><span><a class="post-category post-category-web" href="tags/web.html">web</a></span><span><a class="post-category post-category-git" href="tags/git.html">git</a></span><span><a class="post-category post-category-docker" href="tags/docker.html">docker</a></span></p><div class=post-description><p><p>Pour les besoins de mon statut d&#39;autoentrepreneur, j&#39;avais besoin de pouvoir mettre à disposition de ma clientèle un accès aux sources de mes productions. La solution évidente est bien entendu d&#39;utiliser <a href="https://github.com">github</a> comme tout le monde, mais mon esprit un peu rebelle, opensource et aventurier m&#39;a poussé à tenter d&#39;utiliser gitlab à la place.</p> <p>Je ne partais pas de nulle part cela dit, j&#39;avais déjà mis en place une stack gitlab sur un serveur dédié, mais cette fois je voulais le faire fonctionner sur ma petite instance <a href="https://digitalocean.com">DigitalOcean</a> en tant que conteneur docker.</p> <h2>Mise en place des pré-requis</h2> <p>Les premières choses à mettre en oeuvre est de configurer le noyau pour accepter les limites mémoire de conteneur et de paramétrer l&#39;utilisation du swap. Modifions pour cela le fichier <code>/etc/default/grub</code> avec cette ligne : {% highlight bash %} GRUB<em>CMDLINE</em>LINUX=&ldquo;cgroup_enable=memory swapaccount=1&rdquo; {% endhighlight %} Sans oublier de recharger la configuration : <code>sudo update-grub</code></p> <p>Ensuite il faut éventuellement <a href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04">créer un fichier de swap suffisant</a>, dans la mesure où l&#39;instance de base de DigitalOcean est fournie avec 512M de ram et 0 swap&hellip; ;-)</p> <p>L&#39;installation du docker est également nécessaire, mon système tournant sous ubuntu 14.04, j&#39;ai suivi la <a href="https://docs.docker.com/installation/ubuntulinux/">recommandation officielle</a>.</p> <h2>Dockerisons</h2> <p>Le truc cool, c&#39;est que le boulot est quasiment déjà fait dans la mesure où un fichier <code>Dockerfile</code> est présent dans le <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/docker/Dockerfile">dépôt du code de gitlab</a>.</p> <p>La création de l&#39;image Docker utilise les packets omnibus mis à disposition pour debian. Comme l&#39;indique la documentation, il suffit de taper la commande suivante depuis la racine du dépôt gitlab : {% highlight bash %} docker build -t gitlab<em>image docker/ {% endhighlight %} Une image de conteneur devrait être disponible au terme de cette commande. Il convient désormais de configurer l&#39;environnement de l&#39;hôte pour utiliser cette image. Pour cela, les bonnes pratiques préconisent d&#39;utiliser un conteneur de données qu&#39;on pourra attacher au conteneur exécutant la stack gitlab. {% highlight bash %} docker run &ndash;name gitlab</em>data gitlab_image /bin/true {% endhighlight %} Cela va créer un conteneur de données préconfigurées avec des répertoires partagés suivants&nbsp;:</p> <ul> <li><code>/var/opt/gitlab</code> pour les donnéees de l&#39;application</li> <li><code>/var/log/gitlab</code> pour les logs</li> <li><code>/etc/gitlab</code> pour la configuration</li> </ul> <p>La configuration du conteneur se fait essentiellement dans le fichier <code>/etc/gitlab/gitlab.rb</code> du conteneur de données. C&#39;est un fichier de définitions de tableaux associatifs (ruby) qui surchargent la configuration par défaut (gitlab.yml) via des recettes <a href="https://www.chef.io/chef/">Chef</a> exécutées au démarrage ou au redémarrage du controlleur du conteneur.</p> <p>Pour éditer ce fichier dans le conteneur de données, utiliser la commande suivante : {% highlight bash %} docker run -ti -e TERM=linux &ndash;rm &ndash;volumes-from gitlab<em>data ubuntu vi /etc/gitlab/gitlab.rb {% endhighlight %} On utilise ici un conteneur de base <code>ubuntu</code> pour éditer avec <code>vi</code> le fichier de configuration <code>gitlab.rb</code> au sein du conteneur de données `gitlab</em>data`.</p> <h2>Lancement du conteneur</h2> <p>Il ne reste qu&#39;à lancer le conteneur en précisant les ports sur lesquels on souhaite qu&#39;il réponde : {% highlight bash %} docker run &ndash;name gitlab<em>app &ndash;publish 8080:80 &ndash;publish 2222:22 &ndash;volumes-from gitlab</em>data &ndash;detach gitlab_image {% endhighlight %}</p> <h3>Modification de la configuration à chaud</h3> <p>On peut très bien éditer le fichier <code>gitlab.rb</code> et demander à recharger la configuration. Utiliser pour ceci la commande <code>exec</code> de docker : {% highlight bash %} docker exec -t gitlab_app gitlab-ctl reconfigure {% endhighlight %} Le script va analyser le fichier de configuration et éventuellement relancer les recettes Chef nécessaire avant de relancer les services.</p> <h2>Enjoy!</h2> <p><img alt="Gitlab installé" src="https://dl.dropboxusercontent.com/u/45117371/x/gitlab_docker.png"/></p> </p></div></section></div><footer id=footer><ul class=icons><li><a class="icon fa-envelope-o" href="#email-protection-uryyb@oboznregra.rh"><span class=label>Email</span></a></li><li><a class="icon fa-rss" href="/atom.xml"><span class=label>RSS</span></a></li><li><a class="icon fa-twitter" href="https://twitter.com/bobmaerten"><span class=label>Twitter</span></a></li><li><a class="icon fa-github" href="https://github.com/bobmaerten"><span class=label>Github</span></a></li></ul><ul class=copyright><li>© Bob Maerten</li><li>Design&nbsp;: <a href="http://html5up.net">HTML5 UP</a></li><li>Photo&nbsp;: <a href="http://unsplash.com/juskteez/">Juskteez Vu</a></li></ul></footer><script src="../js/all-39da47a7.js"></script><script type="text/javascript">!function(){try{var a,b,c,d,g=document.getElementsByTagName("a");for(c=0;g.length-c;c++)try{b=g[c].getAttribute("href"),b&&b.indexOf("#email-protection-")>-1&&b.length>19&&(a="",d=19+b.indexOf("#email-protection-"),b.length>d&&(a=b.substr(18).replace(/[a-zA-Z]/g,function(a){return String.fromCharCode(("Z">=a?90:122)>=(a=a.charCodeAt(0)+13)?a:a-26)})),g[c].setAttribute("href","mailto:"+a))}catch(h){}}catch(h){}}();</script>
</body></html>