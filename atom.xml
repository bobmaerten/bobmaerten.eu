<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Bob Maerten ‚Äî Blog Perso</title>
  <subtitle>Humeurs, interrogations, p√¢tisseries, d√©veloppement web, syst√®mes Linux et autres curiosit√©s</subtitle>
  <id>https://bobmaerten.eu/blog</id>
  <link href="https://bobmaerten.eu/blog"/>
  <link href="https://bobmaerten.eu/blog/atom.xml" rel="self"/>
  <updated>2016-01-23T15:16:10+01:00</updated>
  <author>
    <name>Bob Maerten</name>
  </author>
  <entry>
    <title>Utiliser la virtualisation native d'OSX pour Docker</title>
    <link rel="alternate" href="https://bobmaerten.eu/blog/utiliser-la-virtualisation-native-d-osx-pour-docker.html"/>
    <id>https://bobmaerten.eu/blog/utiliser-la-virtualisation-native-d-osx-pour-docker.html</id>
    <published>2016-01-23T15:16:10+01:00</published>
    <updated>2016-01-23T17:52:10+01:00</updated>
    <author>
      <name>Bob Maerten ‚Äî Blog Perso</name>
    </author>
    <content type="html">&lt;p&gt;Docker est un outil linux natif et pour l&amp;#39;utiliser sous OSX (ou Windows) il faut passer par une machine virtuelle sous linux pour faire tourner le &lt;em&gt;daemon&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Pour cela, la pratique courante est d&amp;#39;installer un hyperviseur (habituellement Virtualbox) afin de faire tourner &lt;code&gt;boot2docker&lt;/code&gt;, la micro-VM fournie par Docker afin de l&amp;#39;utiliser sous un autre syst√®me. Mais il est d√©sormais possible de s&amp;#39;en passer sous OSX.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h2&gt;Hypervisor.framework&lt;/h2&gt;

&lt;p&gt;La version 10.10 (Yosemite) d&amp;#39;OSX a introduit un syst√®me de virtualisation natif en mode utilisateur et permet l&amp;#39;utilisation directe des instructions VT-x des processeurs Intel. Cela permet donc de virtualiser des applications, sans extension du noyau.&lt;/p&gt;

&lt;p&gt;D&amp;#39;ailleurs, &lt;a href="http://veertu.com/"&gt;Veertu&lt;/a&gt;, r√©cemment publi√© sur l&amp;#39;app store permet d&amp;#39;installer des VMs en utilisant l&amp;#39;hyperviseur natif d&amp;#39;OSX, explique bien cette diff√©rence.&lt;/p&gt;

&lt;p&gt;&lt;img alt="Legacy Virt" src="http://veertu.com/test/wp-content/uploads/2015/10/legacy.svg" /&gt;
&lt;img alt="OSX Virt" src="http://veertu.com/test/wp-content/uploads/2015/10/new.svg" /&gt;&lt;/p&gt;

&lt;p&gt;Bien que Veertu propose l&amp;rsquo;&lt;a href="https://twitter.com/veertu_labs/status/687552097869533184"&gt;installation de boot2docker&lt;/a&gt; ce n&amp;#39;est pas de ce syst√®me dont je vais vous parler.&lt;/p&gt;

&lt;h2&gt;Xhyve et son driver docker-machine&lt;/h2&gt;

&lt;p&gt;&lt;a href="https://github.com/mist64/xhyve"&gt;Xhyve&lt;/a&gt; s&amp;#39;appuie √©galement sur l&amp;rsquo;&lt;em&gt;hypervisor.framework&lt;/em&gt; d&amp;#39;OSX et permet de virtualiser des syst√®mes linux et BSD tout comme il √©tait possible de le faire avec Virtualbox, mais sans la lourdeur d&amp;#39;Oracle. Son installation est on ne peut plus simple d√®s lors que &lt;em&gt;homebrew&lt;/em&gt; est install√© (&lt;em&gt;t&amp;#39;es un dev sous mac et t&amp;#39;as pas homebrew install√©, nan mais all&amp;hellip;&lt;/em&gt; üò¨) : &lt;code&gt;brew install xhyve&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Mais l√† ou cela devient int√©ressant, c&amp;#39;est qu&amp;#39;il existe d√©sormais un &lt;a href="https://github.com/zchee/docker-machine-driver-xhyve"&gt;driver xhyve pour docker-machine&lt;/a&gt; (celui de Virtualbox est utilis√© par d√©faut si on n&amp;#39;en pr√©cise pas). L&amp;#39;installer est tout aussi simple : &lt;code&gt;brew install docker-machine-driver-xhyve&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Cela dit, je vous recommande chaudement de tout installer avec homebrew. J&amp;#39;avais des restes d&amp;#39;installation de &lt;strong&gt;docker-toolbox&lt;/strong&gt; et la cr√©ation de la VM n&amp;#39;a pas fonctionn√©. Le mieux est donc de supprimer les binaires et de les r√©installer avec homebrew :&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;brew install xhyve docker docker-machine docker-compose docker-machine-driver-xhyve
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Au jour de r√©daction de ce billet, voici les versions install√©es suite √† cette commande :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;xhyve-0.2.0&lt;/li&gt;
&lt;li&gt;docker-1.9.1_1&lt;/li&gt;
&lt;li&gt;docker-machine-0.5.6_1&lt;/li&gt;
&lt;li&gt;docker-compose-1.5.2&lt;/li&gt;
&lt;li&gt;docker-machine-driver-xhyve-0.2.1&lt;/li&gt;
&lt;/ul&gt;

&lt;h2&gt;Cr√©ation et d√©marrage de la VM&lt;/h2&gt;

&lt;p&gt;Pour installer et d√©marrer la VM docker, il suffit d&amp;#39;utiliser docker-machine avec le driver xhyve.&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ docker-machine create dockerhost --driver xhyve
Running pre-create checks...
Creating machine...
(dockerhost) Copying /Users/bob/.docker/machine/cache/boot2docker.iso to /Users/bob/.docker/machine/machines/dockerhost/boot2docker.iso...
(dockerhost) Creating VM...
(dockerhost) Extracting vmlinuz64 and initrd.img from boot2docker.iso...
(dockerhost) /dev/disk2                                                 /Users/bob/.docker/machine/machines/dockerhost/b2d-image
(dockerhost) "disk2" unmounted.
(dockerhost) "disk2" ejected.
(dockerhost) Generating 20000MB disk image...
(dockerhost) created: /Users/bob/.docker/machine/machines/dockerhost/root-volume.sparsebundle
(dockerhost) Creating SSH key...
(dockerhost) Fix file permission...
(dockerhost) Generate UUID...
(dockerhost) Convert UUID to MAC address...
(dockerhost) Starting dockerhost...
(dockerhost) Waiting for VM to come online...
(dockerhost) Waiting on a pseudo-terminal to be ready... done
(dockerhost) Hook up your terminal emulator to /dev/ttys004 in order to connect to your VM
Waiting for machine to be running, this may take a few minutes...
(dockerhost) Getting to VM state...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Detecting the provisioner...
Provisioning with boot2docker...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Checking connection to Docker...
Docker is up and running!
To see how to connect Docker to this machine, run: docker-machine env dockerhost
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Il suffit ensuite de raccrocher l&amp;#39;environnement local √† la nouvelle VM docker :&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ eval "$(docker-machine env dockerhost)"
$ docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
$ docker run --rm busybox echo 'plop!
latest: Pulling from library/busybox
583635769552: Pull complete
b175bcb79023: Pull complete
Digest: sha256:c1bc9b4bffe665bf014a305cc6cf3bca0e6effeb69d681d7a208ce741dad58e0
Status: Downloaded newer image for busybox:latest
plop!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et voil√†, vous pouvez effacer votre stack Virtualbox ! Bon, peut-√™tre pas tout de suite car ceci est encore plut√¥t exp√©rimental, aussi je vais √©prouver la solution dans les jours/semaines qui viennent, et ce sera l&amp;#39;occasion d&amp;#39;un prochain billet pour √©valauer les performances et la fiabilit√© de la &lt;em&gt;stack&lt;/em&gt;.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Comportement des touches Home et End du pav√© num√©rique sous OSX</title>
    <link rel="alternate" href="https://bobmaerten.eu/blog/comportement-des-touches-home-et-end-du-pave-numerique-sous-osx.html"/>
    <id>https://bobmaerten.eu/blog/comportement-des-touches-home-et-end-du-pave-numerique-sous-osx.html</id>
    <published>2015-06-26T17:23:10+02:00</published>
    <updated>2015-11-08T12:29:14+01:00</updated>
    <author>
      <name>Bob Maerten ‚Äî Blog Perso</name>
    </author>
    <content type="html">&lt;p&gt;Le truc qui me rendait fous depuis mon passage sous OSX c&amp;#39;√©tait le comportement des touches &lt;code&gt;Home&lt;/code&gt; et &lt;code&gt;End&lt;/code&gt; du pav√© num√©rique. En tant que d√©veloppeur, dans mon √©diteur de texte, le comportement est d&amp;#39;aller respectivement en d√©but et en fin de ligne. Or dans le navigateur et en particulier dans les &lt;em&gt;textarea&lt;/em&gt; de GitHub, le comportement des touches en question est rattach√© au &lt;em&gt;viewport&lt;/em&gt; du navigateur. Si bien que lorsque naturellement j&amp;#39;appuie sur &lt;code&gt;Home&lt;/code&gt; pour revenir en d√©but de ligne, mon navigateur me renvoyait en d√©but de page.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;p&gt;&lt;img alt="Rage" src="http://media.giphy.com/media/wvQIqJyNBOCjK/giphy.gif" /&gt;&lt;/p&gt;

&lt;p&gt;Mais en fouillant un peu, ce comportement ne semble pas naturel pour pas de gens, qui pour le coup installent un outil appel√© &lt;a href="https://pqrs.org/osx/karabiner/"&gt;Karabiner&lt;/a&gt;, permettant de modifier le comportement du clavier en g√©n√©ral.&lt;/p&gt;

&lt;p&gt;Cependant le comportement modifi√© rentrait en conflit avec ma configuration sous iTerm2, ce n&amp;#39;√©tait donc pas mieux.&lt;/p&gt;

&lt;p&gt;Au final, c&amp;#39;est dans &lt;a href="http://www.evansweb.info/2005/03/24/mac-os-x-and-home-end-keys/"&gt;un billet&lt;/a&gt; du &lt;a href="http://www.evansweb.info/"&gt;blog de Jon Evans&lt;/a&gt; datant de plus de 10 que je trouve une solution simple, rapide, parfaitement adapt√©e et toujours valide&amp;nbsp;! Le site ne semble plus aliment√© depuis quelques ann√©es mais est toujours dispo, chapeau bas &lt;a href="https://twitter.com/burmasauce"&gt;@burmasauce&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Toujours est-il que la solution est de cr√©er un fichier &lt;code&gt;~/Library/KeyBindings/DefaultKeyBinding.dict&lt;/code&gt; contenant&amp;nbsp;:&lt;/p&gt;
&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="err"&gt;/*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;Remap&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;Home&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;End&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;be&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;correct&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;:-)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;*/&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="nt"&gt;"\UF729"&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="err"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;"moveToBeginningOfLine:"&lt;/span&gt;&lt;span class="err"&gt;;&lt;/span&gt;&lt;span class="w"&gt;                   &lt;/span&gt;&lt;span class="err"&gt;/*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;Home&lt;/span&gt;&lt;span class="w"&gt;         &lt;/span&gt;&lt;span class="err"&gt;*/&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="nt"&gt;"\UF72B"&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="err"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;"moveToEndOfLine:"&lt;/span&gt;&lt;span class="err"&gt;;&lt;/span&gt;&lt;span class="w"&gt;                         &lt;/span&gt;&lt;span class="err"&gt;/*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;End&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="err"&gt;*/&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="nt"&gt;"$\UF729"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;"moveToBeginningOfLineAndModifySelection:"&lt;/span&gt;&lt;span class="err"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;/*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;Shift&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;Home&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;*/&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="nt"&gt;"$\UF72B"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;"moveToEndOfLineAndModifySelection:"&lt;/span&gt;&lt;span class="err"&gt;;&lt;/span&gt;&lt;span class="w"&gt;       &lt;/span&gt;&lt;span class="err"&gt;/*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;Shift&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;End&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="err"&gt;*/&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="err"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;et de red√©marrer une nouvelle session afin de retrouver un niveau de sant√© mentale viable.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Quelques d√©boires avec le webservice de Prestashop</title>
    <link rel="alternate" href="https://bobmaerten.eu/blog/quelques-deboires-avec-le-webservice-de-prestashop.html"/>
    <id>https://bobmaerten.eu/blog/quelques-deboires-avec-le-webservice-de-prestashop.html</id>
    <published>2015-06-17T21:15:39+02:00</published>
    <updated>2015-11-08T12:29:14+01:00</updated>
    <author>
      <name>Bob Maerten ‚Äî Blog Perso</name>
    </author>
    <content type="html">&lt;p&gt;Tiens il y avait un moment que je n&amp;#39;avais pas √©crit par ici, et une fois n&amp;#39;est pas coutume il s&amp;#39;agit d&amp;#39;un billet pour √©vacuer. C&amp;#39;est Prestashop qui va en prendre pour son grade. Eh oui, Prestashop. Car m√™me si mon activit√© principale est d&amp;#39;√©voluer avec Ruby on Rails, il arrive √† l&amp;#39;occasion que l&amp;#39;on doivent explorer d&amp;#39;autres univers.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;p&gt;Dans le cadre du boulot nous devons actuellement interfacer un &lt;em&gt;backoffice&lt;/em&gt; maison avec un &lt;em&gt;front-end&lt;/em&gt; Prestashop. Pour cela, nous avons pris le parti d&amp;#39;utiliser au maximum l&amp;#39;API REST de l&amp;#39;outil. Celle-ci est assez bien fichue car elle permet non seulement d&amp;#39;acc√©der aux principaux √©l√©ments de la boutique (produits, commandes, clients, stocks, etc.) mais √©galement de les modifier. Et c&amp;#39;est sur ces mises √† jour que s&amp;#39;est d√©vers√© la rage que je tente d&amp;#39;√©vacuer ici‚Ä¶&lt;/p&gt;

&lt;p&gt;J&amp;#39;avais des erreurs 500 qui se d√©clenchaient lors de mes tentatives de mise √† jours via le webservice, mais rien d&amp;#39;autre. Les retours des appels HTTP se contentaient de pr√©ciser d&amp;#39;aller voir les logs, dans lesquels il n&amp;#39;y avait bien √©videmment rien, malgr√© un param√©trage de PHP/Apache plut√¥t verbeux.&lt;/p&gt;

&lt;p&gt;Il faut savoir que les appels √† l&amp;#39;API ne sont pas verbeux par d√©faut, et il m&amp;#39;a fallu longuement chercher pour comprendre et forcer le syst√®me de verbosit√© du webservice de Prestashop. J&amp;#39;ai clairement perdu les r√©flexes et les usages des applications PHP, et surtout travaillant avec Rails, on s&amp;#39;habitue vite aux environnements bien isol√©s et proprement d√©clar√©s (merci &lt;code&gt;RAKE_ENV/RAILS_ENV&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;Par convention les valeurs permettant de contr√¥ler le comportement de Prestashop sont √† modifier dans &lt;code&gt;config/settings.inc.php&lt;/code&gt;. Or pour la verbosit√© des messages d&amp;#39;erreurs du webservice, il faut forcer dans &lt;code&gt;config/defines.inc.php&lt;/code&gt; la variable &lt;code&gt;_PS_MODE_DEV_&lt;/code&gt; √† &lt;strong&gt;true&lt;/strong&gt; par que dans celui dans lequel on s&amp;#39;attend √† ce que √ßa fonctionne, eh bien, √ßa ne fonctionne pas. Et je passe sur le fait de devoir fonctionner en mode &lt;code&gt;DEV&lt;/code&gt; pour avoir les messages d&amp;#39;erreurs de l&amp;#39;API. Eh donc √ßa veut dire qu&amp;#39;en prod, tu dois tourner en mode dev aussi&amp;nbsp;?!&lt;/p&gt;

&lt;p&gt;D&amp;#39;autre part, la consigne dans les documentations du webservice stipulent bien que pour la modification d&amp;#39;une ressource il faut d&amp;#39;abord r√©cup√©rer le contenu XML via le webservice pour le renvoyer selon le m√™me format avec les modifications. Cela ne fonctionnait pas sur certaines ressources (stock, produits, etc.) mais par manque de verbosit√© des messages il √©tait d√©licat de comprendre pourquoi.&lt;/p&gt;

&lt;p&gt;Avec des messages plus ‚Äúclairs‚Äù sur la mise √† jour du stock comme : ‚ÄúVous ne pouvez pas mettre √† jour le stock disponible quand il d√©pend du stock‚Äù, ce n&amp;#39;est pas forc√©ment beaucoup plus √©vident, mais en l&amp;#39;occurrence l&amp;#39;id√©e est ici de modifier non seulement la valeur de quantit√© mais √©galement la valeur de &lt;code&gt;depends_on_stock&lt;/code&gt;. Je n&amp;#39;aurais jamais trouv√© sans l&amp;#39;affichage de ces messages d&amp;#39;erreurs&amp;nbsp;!&lt;/p&gt;

&lt;p&gt;D&amp;#39;autres sont plus myst√©rieux dans la mesure ou il faut supprimer des lignes pour que la validation de la ressource s&amp;#39;effectue correctement. Ce n&amp;#39;est bien √©videmment pas pr√©cis√© dans la documentation, uniquement sur ces fichus messages d&amp;#39;erreur. Pour la mise √† jour d&amp;#39;un produit par exemple&amp;nbsp;: ‚Äú&lt;em&gt;parameter &lt;code&gt;manufacturer_name&lt;/code&gt; not writable. Please remove this attribute of this XML&lt;/em&gt;‚Äù, signifie qu&amp;#39;il faut supprimer le param√®tre sp√©cifi√© dans le XML pass√© (et &lt;code&gt;quantity&lt;/code&gt; √©galement au passage, message qui n&amp;#39;appara√Æt qu&amp;#39;√† la tentative suivante‚Ä¶). Bref, tout cela va peut-√™tre sans dire pour les habitu√©s du &lt;em&gt;framework&lt;/em&gt;, mais √ßa va tout de m√™me mieux en le disant.&lt;/p&gt;

&lt;p&gt;D√©j√† que j&amp;#39;√©tais pas fan de XML, mais l√†, devoir le triturer pour pouvoir mettre √† jour des donn√©es, c&amp;#39;√©tait le pompon. Heureusement qu&amp;#39;il y a des &lt;em&gt;libs&lt;/em&gt; qui font √ßa √† peu pr√®s bien, mais tout √ßa reste du XML et quelque part, pas franchement naturel √† utiliser.&lt;/p&gt;

&lt;p&gt;Allez, on va dire que c&amp;#39;√©tait un mauvais moment √† passer. Jusqu&amp;#39;√† la prochaine mise √† jour de l&amp;#39;API‚Ä¶ üò¨&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Passage de boot2docker √† docker-machine</title>
    <link rel="alternate" href="https://bobmaerten.eu/blog/passage-de-boot2docker-a-docker-machine.html"/>
    <id>https://bobmaerten.eu/blog/passage-de-boot2docker-a-docker-machine.html</id>
    <published>2015-05-17T13:12:14+02:00</published>
    <updated>2015-11-08T12:29:14+01:00</updated>
    <author>
      <name>Bob Maerten ‚Äî Blog Perso</name>
    </author>
    <content type="html">&lt;p&gt;Entre mon nouveau job, mon passage √† OSX pour le boulot, et la d√©faillance de mon portable sous Linux, j&amp;#39;ai eu peu de temps √† consacrer √† l&amp;#39;actualit√© de Docker. Cependant √ßa bouge pas mal ces derniers temps avec des projets comme &lt;a href="https://docs.docker.com/machine/"&gt;machine&lt;/a&gt;, &lt;a href="https://docs.docker.com/compose/"&gt;compose&lt;/a&gt; et &lt;a href="https://docs.docker.com/swarm/"&gt;swarm&lt;/a&gt; et j&amp;#39;ai r√©cemment essay√© de rattraper un peu le retard. Dans ce billet je vais exposer ma d√©couverte de &lt;code&gt;docker-machine&lt;/code&gt; qui m&amp;#39;a permis de retrouver l&amp;#39;usage courant que j&amp;#39;avais de docker sous Linux.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h2&gt;Boot2Docker&lt;/h2&gt;

&lt;p&gt;Comme un bon OSXien bien √©lev√© au grain, j&amp;#39;ai tout d&amp;#39;abord suivi les conseils du net en installant &lt;a href="https://github.com/boot2docker/boot2docker"&gt;boot2docker&lt;/a&gt; pour faire fonctionner docker sous forme d&amp;#39;une VM Linux sous VirtualBox. La proc√©dure est tr√®s simple&amp;nbsp;:&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ brew cask install virtualbox
$ brew install boot2docker
$ boot2docker up
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Les recettes installent les derni√®res versions des logiciels requis. &lt;code&gt;boot2docker&lt;/code&gt; est au final un executable permettant de lancer/stopper/mettre √† jour la VM en suivant les mises √† jour de docker. Jusque l√† tout va bien, on parvient m√™me √† oublier la pr√©sence de cette VM et il m&amp;#39;est arriv√© de chercher la cause de l&amp;#39;absence d&amp;#39;un service web en appelant &lt;code&gt;http://localhost:&amp;lt;service_port&amp;gt;&lt;/code&gt; au lieu de &lt;code&gt;http://&amp;lt;boot2docker_ip&amp;gt;:&amp;lt;service_port&amp;gt;&lt;/code&gt;&amp;hellip;&lt;/p&gt;

&lt;p&gt;Il existe certes quelques soucis de performances inh√©rents √† l&amp;#39;usage de VirtualBox qui n&amp;#39;est pas par d√©finition tr√®s v√©loce sur les syst√®mes de fichiers. Cel√† dit pour un usage en d√©veloppent ce n&amp;#39;est pas tr√®s ennuyeux, et il existe des &lt;a href="http://blog.blackfire.io/how-we-use-docker.html"&gt;solutions de contournement&lt;/a&gt;.&lt;/p&gt;

&lt;h2&gt;Docker Machine&lt;/h2&gt;

&lt;p&gt;Derni√®rement, le sous-projet &lt;code&gt;machine&lt;/code&gt; est arriv√© chez Docker permettant de faire la m√™me chose mais avec la possibilit√© d&amp;#39;utiliser diff√©rents &lt;em&gt;drivers&lt;/em&gt;. En fonction du &lt;em&gt;driver&lt;/em&gt; utilis√© &lt;code&gt;machine&lt;/code&gt; va installer un syst√®me d&amp;#39;exploitation permettant d&amp;#39;utiliser docker sur la cible indiqu√©e. Cette cible pouvant √™tre un fournisseur de ressources sur le &lt;em&gt;cloud&lt;/em&gt; ou votre propre installation VirtualBox locale.&lt;/p&gt;

&lt;p&gt;L&amp;#39;int√©r√™t √©vident ici est de permettre d&amp;#39;utiliser les m√™mes commandes et d&amp;#39;acqu√©rir les m√™mes habitudes quel que soit l&amp;#39;environnement cible que l&amp;#39;on manipule (dev, staging, prod) et quelque soit le service utilis√© (VirtualBox, service Cloud, voire en d√©veloppant son propre &lt;em&gt;driver&lt;/em&gt;).&lt;/p&gt;

&lt;p&gt;Pour r√©pliquer l&amp;#39;environnement boot2docker, il suffit donc d&amp;#39;installer &lt;code&gt;docker-machine&lt;/code&gt; ou de suivre les &lt;a href="https://docs.docker.com/machine/#installation"&gt;consignes d&amp;#39;installation&lt;/a&gt; du site officiel. D√®s lors, &lt;code&gt;machine&lt;/code&gt; va t√©l√©charger au besoin la derni√®re version de l&amp;#39;iso de &lt;em&gt;boot2docker&lt;/em&gt; et d√©ployer une nouvelle VM sous VirtualBox, exactement de la m√™me mani√®re que le processus ‚Äúnatif‚Äù de boot2docker.&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ brew install docker-machine
$ docker-machine create --driver virtualbox dev
INFO[0000] Creating SSH key...
INFO[0000] No default boot2docker iso found locally, downloading the latest release...
INFO[0001] Downloading latest boot2docker release to /Users/bob/.docker/machine/cache/boot2docker.iso...
INFO[0044] Creating VirtualBox VM...
INFO[0051] Starting VirtualBox VM...
INFO[0051] Waiting for VM to start...
INFO[0103] 'dev' has been created and is now the active machine.
INFO[0103] To point your Docker client at it, run this in your shell: eval '$(docker-machine env dev)'
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Remarquez la derni√®re ligne qui est assez importante. Lancer &lt;code&gt;eval &amp;#39;$(docker-machine env dev)&amp;#39;&lt;/code&gt; permet en effet de param√©trer le &lt;em&gt;shell&lt;/em&gt; courant pour permettre d&amp;#39;utiliser l&amp;#39;environnement choisi avec les outils docker.&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ eval '$(docker-machine env dev)'

$ docker info
Containers: 0
Images: 0
Storage Driver: aufs
Root Dir: /mnt/sda1/var/lib/docker/aufs
Backing Filesystem: extfs
Dirs: 0
Dirperm1 Supported: true
Execution Driver: native-0.2
Kernel Version: 4.0.3-boot2docker
Operating System: Boot2Docker 1.6.2 (TCL 5.4); master : 4534e65 - Wed May 13 21:24:28 UTC 2015
CPUs: 8
Total Memory: 997.3 MiB
Name: dev
[...]
Labels:
 provider=virtualbox

$ docker run busybox echo Hello World
Unable to find image 'busybox:latest' locally
latest: Pulling from busybox
cf2616975b4a: Pull complete
6ce2e90b0bc7: Pull complete
8c2e06607696: Already exists
busybox:latest: The image you are pulling has been verified. Important: image verification is a tech preview feature and should not be relied on to provide security.
Digest: sha256:38a203e1986cf79639cfb9b2e1d6e773de84002feea2d4eb006b52004ee8502d
Status: Downloaded newer image for busybox:latest
Hello World

$ docker ps -a
CONTAINER ID        IMAGE               COMMAND              CREATED             STATUS                      PORTS               NAMES
d289f3082caf        busybox:latest      'echo Hello World'   11 seconds ago      Exited (0) 11 seconds ago                       drunk_pare
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et comme je le disais plus haut, le &lt;em&gt;workflow&lt;/em&gt; est exactement le m√™me en utilisant un autre &lt;em&gt;driver&lt;/em&gt;&amp;nbsp;:&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ docker-machine create --driver digitalocean --digitalocean-access-token=$MY_ACCESS_TOKEN docker-prod
INFO[0000] Creating SSH key...
INFO[0001] Creating Digital Ocean droplet...
INFO[0201] 'docker-prod' has been created and is now the active machine.
INFO[0201] To point your Docker client at it, run this in your shell: eval '$(docker-machine env docker-prod)'

$ eval '$(docker-machine env docker-prod)'

$ docker run busybox echo Hello World
Unable to find image 'busybox:latest' locally
latest: Pulling from busybox
cf2616975b4a: Pull complete
6ce2e90b0bc7: Pull complete
8c2e06607696: Already exists
busybox:latest: The image you are pulling has been verified. Important: image verification is a tech preview feature and should not be relied on to provide security.
Digest: sha256:38a203e1986cf79639cfb9b2e1d6e773de84002feea2d4eb006b52004ee8502d
Status: Downloaded newer image for busybox:latest
Hello World

$ docker ps -a
CONTAINER ID        IMAGE               COMMAND              CREATED             STATUS                     PORTS               NAMES
7b8b283fceaa        busybox:latest      'echo Hello World'   11 seconds ago      Exited (0) 9 seconds ago                       gloomy_bohr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et ces deux environnements sont d√©sormais accessibles en permuttant d&amp;#39;une cible √† l&amp;#39;autre avec la commande &lt;code&gt;eval&lt;/code&gt; indiqu√©e au d√©marrage d&amp;#39;une machine&amp;nbsp;:&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ docker-machine ls
NAME          ACTIVE   DRIVER         STATE     URL                         SWARM
dev                    virtualbox     Running   tcp://192.168.99.102:2376
docker-prod   *        digitalocean   Running   tcp://45.55.254.233:2376

$ eval '$(docker-machine env dev)'

$ docker ps -a
CONTAINER ID        IMAGE               COMMAND              CREATED             STATUS                      PORTS               NAMES
d289f3082caf        busybox:latest      'echo Hello World'   2 minutes ago       Exited (0) 2 minutes ago                        drunk_pare
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;Acc√©der aux containers depuis l&amp;#39;h√¥te&lt;/h2&gt;

&lt;p&gt;Il y avait encore quelque chose qui me g√™nait dans l&amp;#39;usage d&amp;#39;une VM pour Docker en local, c&amp;#39;est l&amp;#39;acc√®s aux containers directement depuis ma machine. Sous linux, Docker est expos√© sur une interface rout√©e par d√©faut. Avec une VM sous VirtualBox, il faut d√©clarer la route manuellement&amp;nbsp;:&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ /usr/sbin/scutil -w State:/Network/Interface/vboxnet0/IPv4 -t 0

$ sudo /sbin/route -n add -net 172.17.0.0 -netmask 255.255.0.0 -gateway $(docker-machine ip)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On peut ainsi cr√©er un &lt;em&gt;container&lt;/em&gt; et le &lt;em&gt;ping&lt;/em&gt;er depuis le syst√®me local.&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ docker run --name=redis -d redis

$ ping -c 3 $(docker inspect --format '{{ .NetworkSettings.IPAddress }}' $(docker ps -ql))
PING 172.17.0.1 (172.17.0.1): 56 data bytes
64 bytes from 172.17.0.1: icmp_seq=0 ttl=63 time=3.164 ms
64 bytes from 172.17.0.1: icmp_seq=1 ttl=63 time=3.985 ms
64 bytes from 172.17.0.1: icmp_seq=2 ttl=63 time=9.379 ms

--- 172.17.0.1 ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 3.164/5.509/9.379/2.757 ms
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Cette manipulation ne r√©sistant pas au reboot, sous OSX on peut ajouter un &lt;code&gt;plist&lt;/code&gt; pour remettre la route au d√©marrage de la machine. Il faut toutefois faire attention √† quel &lt;em&gt;vboxnet&lt;/em&gt; est rattach√© la VM et quelle est l&amp;#39;ip attribu√©e par VirtualBox&amp;nbsp;:&lt;/p&gt;

&lt;p&gt;Voici le plist (&lt;code&gt;/Library/LaunchDaemons/com.docker.route.plist&lt;/code&gt;) pour ma VM sur le vboxnet0 et d&amp;#39;adresse IP 192.168.99.100&lt;/p&gt;
&lt;pre class="highlight xml"&gt;&lt;code&gt;&lt;span class="cp"&gt;&amp;lt;?xml version='1.0' encoding='UTF-8'?&amp;gt;&lt;/span&gt;
&lt;span class="cp"&gt;&amp;lt;!DOCTYPE plist PUBLIC '-//Apple//DTD PLIST 1.0//EN' 'http://www.apple.com/DTDs/PropertyList-1.0.dtd'&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;plist&lt;/span&gt; &lt;span class="na"&gt;version=&lt;/span&gt;&lt;span class="s"&gt;'1.0'&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;dict&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;key&amp;gt;&lt;/span&gt;Label&lt;span class="nt"&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;string&amp;gt;&lt;/span&gt;com.docker.route&lt;span class="nt"&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;key&amp;gt;&lt;/span&gt;ProgramArguments&lt;span class="nt"&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;array&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;string&amp;gt;&lt;/span&gt;bash&lt;span class="nt"&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;string&amp;gt;&lt;/span&gt;-c&lt;span class="nt"&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
    &lt;span class="c"&gt;&amp;lt;!-- You need to adapt the vboxnet0 to the interface that suits your setup, use ifconfig to find it --&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;string&amp;gt;&lt;/span&gt;/usr/sbin/scutil -w State:/Network/Interface/vboxnet0/IPv4 -t 0;sudo /sbin/route -n add -net 172.17.0.0 -netmask 255.255.0.0 -gateway 192.168.99.100&lt;span class="nt"&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/array&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;key&amp;gt;&lt;/span&gt;KeepAlive&lt;span class="nt"&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;false/&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;key&amp;gt;&lt;/span&gt;RunAtLoad&lt;span class="nt"&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;true/&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;key&amp;gt;&lt;/span&gt;LaunchOnlyOnce&lt;span class="nt"&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;true/&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/dict&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/plist&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;Bonus: acc√©der aux containers par un nom DNS&lt;/h2&gt;

&lt;p&gt;Le top du top serait d&amp;#39;avoir un syst√®me qui permet d&amp;#39;acc√©der aux conteneurs cr√©√©s par leur nom plut√¥t que par un IP ou une redirection de port. On trouve pas mal de projets li√©s √† cette probl√®matique sur github, mais celui qui a retenu mon attention est &lt;a href="https://github.com/tonistiigi/dnsdock"&gt;dnsdock&lt;/a&gt;. Il s&amp;#39;appuie sur les recherches d&amp;rsquo;&lt;a href="http://www.asbjornenge.com/wwc/vagrant_skydocking.html"&gt;autres&lt;/a&gt; &lt;a href="https://github.com/tonistiigi/dnsdock"&gt;projet&lt;/a&gt;, mais il a pour lui la simplicit√© que je recherchais √† la fois dans son installation et son utilisation.&lt;/p&gt;

&lt;p&gt;Dans un premier temps il suffit de lancer un conteneur qui va rep√©rer la cr√©ation/suppression d&amp;#39;autre conteneur et enregistrer leurs nom dans un service DNS&amp;nbsp;:&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ docker run -d -v /var/run/docker.sock:/var/run/docker.sock --name dnsdock --restart=always -p 172.17.42.1:53:53/udp tonistiigi/dnsdock
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notez l&amp;#39;utilisation &lt;code&gt;--restart=always&lt;/code&gt; permettant de recharger le container au red√©marrage de la VM.&lt;/p&gt;

&lt;p&gt;Ensuite, il suffit d&amp;#39;ajouter un &lt;code&gt;resolver&lt;/code&gt; √† OSX pour r√©soudre les noms des conteneurs avec le suffixe &lt;code&gt;.docker&lt;/code&gt; (voir la documentation de dnsdock pour un param√©trage diff√©rent).&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ sudo mkdir -p /etc/resolver ; echo 'nameserver 172.17.42.1' | sudo tee /etc/resolver/docker

$ ping redis.docker
PING redis.docker (172.17.0.2): 56 data bytes
64 bytes from 172.17.0.2: icmp_seq=0 ttl=63 time=2.256 ms
64 bytes from 172.17.0.2: icmp_seq=1 ttl=63 time=5.212 ms
64 bytes from 172.17.0.2: icmp_seq=2 ttl=63 time=2.228 ms

--- redis.docker ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 2.228/3.232/5.212/1.400 ms
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A priori il est possible de faire la m√™me chose sous Linux en ajoutant l&amp;#39;adresse de &lt;em&gt;bridge&lt;/em&gt; au fichier &lt;code&gt;/etc/resolv.conf&lt;/code&gt; en tant que &lt;em&gt;resolver&lt;/em&gt;, mais n&amp;#39;en ayant plus sous la main je ne peux donner de mode op√©ratoire. L&amp;#39;utilisation d&amp;#39;une autre image comme &lt;a href="https://github.com/iverberk/docker-spy"&gt;docker-spy&lt;/a&gt; pourrait √™tre opportune √©galement.&lt;/p&gt;

&lt;h2&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Voil√†, j&amp;#39;ai d√©sormais de quoi faire tourner des conteneurs Docker de mani√®re pas trop douloureuse sous OSX, mais entre boot2docker et docker-machine alors, comment choisir&amp;nbsp;? Les moins de 40 ans ne comprendront surement pas l&amp;#39;allusion mais voici ma petite recette pour choisir.&lt;/p&gt;

&lt;p&gt;&lt;img alt="Pub FLUOGUM" src="http://i.imgur.com/QkkmmIs.png" /&gt;&lt;/p&gt;

&lt;p&gt;√Ä ma gauche un &lt;em&gt;host&lt;/em&gt; qui tourne sous boot2docker.&lt;/p&gt;

&lt;p&gt;√Ä ma droite mon &lt;em&gt;host&lt;/em&gt; qui tourne sous docker-machine.&lt;/p&gt;

&lt;p&gt;A priori c&amp;#39;est la m√™me chose, mais ce n&amp;#39;est pas la m√™me chose !&lt;/p&gt;

&lt;p&gt;Car dans mon host, y&amp;#39;a du docker-machine,&lt;/p&gt;

&lt;p&gt;et ‚ô´ ‚Äúdocker-machine, c&amp;#39;est bon pour &lt;a href="https://twitter.com/icecrime/status/599928881953443840"&gt;cr√©er et switcher d&amp;#39;environnement&lt;/a&gt;&amp;nbsp;!‚Äù&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Retour (virtuel) des commentaires</title>
    <link rel="alternate" href="https://bobmaerten.eu/blog/retour-virtuel-des-commentaires.html"/>
    <id>https://bobmaerten.eu/blog/retour-virtuel-des-commentaires.html</id>
    <published>2015-05-10T18:09:02+02:00</published>
    <updated>2015-11-08T12:29:14+01:00</updated>
    <author>
      <name>Bob Maerten ‚Äî Blog Perso</name>
    </author>
    <content type="html">&lt;p&gt;Cela faisait un petit moment que je voulais r√©int√©ger les commentaires sur ce blog. √âtant h√©berg√© sur GitHub Pages et donc purement statique, la solution est forc√©ment externe. Je ne souhaitais pas pour autant utiliser le service √©vident pour ce genre de chose (disqus).&lt;/p&gt;

&lt;p&gt;Non pas que j&amp;#39;eusse de quelconques griefs envers ce service mais dans la continuit√© de proposer du contenu relativement maitris√© (un site statique), je souhaiter √©galement maitriser cette partie commentaires. J&amp;#39;avais fait quelques essais il y quelques mois avec une appli Rails appel√©e &lt;a href="https://github.com/phusion/juvia"&gt;Juvia&lt;/a&gt; produite par &lt;a href="http://www.phusion.nl"&gt;Phusion&lt;/a&gt; qui manifestment n&amp;#39;est plus maintenue, mais qui a poutant √©t√© mis √† jour entre temps en 4.2.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;p&gt;Je me suis dit que ce serait une bonne occasion de tester la mise en place de cette application dans un container Docker. De plus cela me permettrait d&amp;#39;associer la veille technologique n√©cessaire √† cette mise en place avec mes nouvelles activit√©s professionnelles (Rails + Sysadm + H√©bergement).&lt;/p&gt;

&lt;h2&gt;Construction de l&amp;#39;image&lt;/h2&gt;

&lt;p&gt;Les gens qui gravitent autour de docker ne ch√¥ment pas. Des images officielles pour faire tourner des scripts &lt;a href="https://registry.hub.docker.com/_/ruby/"&gt;ruby&lt;/a&gt; et m√™me des applications &lt;a href="https://registry.hub.docker.com/_/rails/"&gt;rails&lt;/a&gt; sont disponibles. En regardant le Dockerfile de l&amp;#39;image rails, on remarque qu&amp;#39;elle surcharge celle de ruby2.2, qui elle m√™me s&amp;#39;appuie sur une succession d&amp;#39;images d√©riv√©es de debian:jessie. Ce qui signifie qu&amp;#39;il est toujours possible d&amp;#39;ajouter de nouveaux packages en cas d&amp;#39;usage d&amp;#39;une gem qui n√©cessite une compilation particuli√®re.&lt;/p&gt;

&lt;p&gt;C&amp;#39;est ce qui s&amp;#39;est produit lors de l&amp;#39;essai de contruction de l&amp;#39;image de l&amp;#39;application de gestion des commentaires dont il est question ici. Le &lt;code&gt;Dockerfile&lt;/code&gt; est tr√®s simple comme le recommande le README de l&amp;#39;image, mais la construction √©choue&amp;nbsp;:&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ cat Dockerfile
FROM rails:onbuild

$ docker build -t juvia_image .
Sending build context to Docker daemon 160.5 MB
Sending build context to Docker daemon
Step 0 : FROM rails:onbuild
# Executing 4 build triggers
Trigger 0, COPY Gemfile /usr/src/app/
Step 0 : COPY Gemfile /usr/src/app/
 ---&amp;gt; Using cache
Trigger 1, COPY Gemfile.lock /usr/src/app/
Step 0 : COPY Gemfile.lock /usr/src/app/
 ---&amp;gt; Using cache
Trigger 2, RUN bundle install
Step 0 : RUN bundle install
 ---&amp;gt; Running in f004b22629a9
Don't run Bundler as root. Bundler can ask for sudo if it is needed, and
installing your bundle as root will break this application for all non-root
users on this machine.
Fetching gem metadata from https://rubygems.org/.........
Fetching version metadata from https://rubygems.org/...
Fetching dependency metadata from https://rubygems.org/..
Using rake 10.4.2
Installing i18n 0.7.0
Installing json 1.8.2
...
Installing capybara-screenshot 1.0.9

Gem::Ext::BuildError: ERROR: Failed to build gem native extension.

    /usr/local/bin/ruby -r ./siteconf20150510-5-1wvt9so.rb extconf.rb
Command 'qmake -spec linux-g++ ' not available

Makefile not found

Gem files will remain installed in /usr/local/bundle/gems/capybara-webkit-1.3.1 for inspection.
Results logged to /usr/local/bundle/extensions/x86_64-linux/2.2.0-static/capybara-webkit-1.3.1/gem_make.out
An error occurred while installing capybara-webkit (1.3.1), and Bundler cannot
continue.
Make sure that `gem install capybara-webkit -v '1.3.1'` succeeds before
bundling.
INFO[0154] The command [/bin/sh -c bundle install] returned a non-zero code: 5
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Comme on le constate, il manque l&amp;#39;outil &lt;code&gt;qmake&lt;/code&gt; pour que capybara-webkit puisse se compiler. Il faudrait ajouter l&amp;#39;installation du paquet en question dans le Dockerfile. Mais cette gem est dans les groupes :development et :test, qui ne sont pas utiles pour le fonctionnement en production. Pour √©viter leur installation, il faudrait pouvoir pr√©ciser &lt;code&gt;--without test development&lt;/code&gt; √† la commande bundle. Dans tous les cas, il faut r√©√©crire le Dockerfile et en s&amp;#39;inspirant de celui de l&amp;#39;image rails, on arrive √† quelque chose comme √ßa&amp;nbsp;:&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ cat Dockerfile
FROM ruby:2.2.2
RUN apt-get update \
        &amp;amp;&amp;amp; apt-get install sqlite3 nodejs --no-install-recommends -y qt5-default libqt5webkit5-dev \
        &amp;amp;&amp;amp; apt-get clean \
        &amp;amp;&amp;amp; rm -rf /var/lib/apt/lists/*

RUN bundle config --global frozen 1

ENV RAILS_ENV production

RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app

COPY Gemfile /usr/src/app/Gemfile
COPY Gemfile.lock /usr/src/app/Gemfile.lock
RUN bundle install --without='development test postgres mysql' --path=help

COPY . /usr/src/app

RUN bundle exec rake db:create \
 &amp;amp;&amp;amp; bundle exec rake db:schema:load \
 &amp;amp;&amp;amp; bundle exec rake assets:precompile RAILS_GROUPS=assets

EXPOSE 3000
CMD ['rails', 'server', '-b', '0.0.0.0']
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Je passe les petites corrections pour avoir les bonnes valeurs sur les fichiers sensibles de Rails (SECREY_KEY_BASE en production, des valeurs correctes dans database.yml, etc.). Au final l&amp;#39;image se construit et on peut valider le fonctionnement.&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;$ docker run --detach --name juvia_app -e SECRET_KEY_BASE='abcde' juvia_image
3489371959f964b3b7d85e2bbda19d294a2c841b0a987261d68794c21bb4d59b

$ docker logs juvia_app
[2015-05-10 17:18:12] INFO  WEBrick 1.3.1
[2015-05-10 17:18:12] INFO  ruby 2.2.2 (2015-04-13) [x86_64-linux]
[2015-05-10 17:18:12] INFO  WEBrick::HTTPServer#start: pid=1 port=3000

$ curl -I $(boot2docker ip):3000
HTTP/1.1 302 Found
X-Frame-Options: SAMEORIGIN
X-Xss-Protection: 1; mode=block
X-Content-Type-Options: nosniff
Location: http://192.168.59.103:3000/admin/dashboard/new_admin
Content-Type: text/html; charset=utf-8
Cache-Control: no-cache
X-Request-Id: ba8299a1-d93d-4a14-93c1-d573e2c31178
X-Runtime: 0.002761
Server: WEBrick/1.3.1 (Ruby/2.2.2/2015-04-13)
Date: Sun, 10 May 2015 17:21:14 GMT
Content-Length: 0
Connection: Keep-Alive
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Oui, vous constatez l&amp;#39;utilisation de &lt;a href="http://boot2docker.io"&gt;boot2docker&lt;/a&gt;. Depuis mon passage sur OSX, mon portable sous linux a rendu l&amp;#39;√¢me (carte m√®re grill√©), donc je me suis rabattu sur un environnement compatible, malgr√© &lt;a href="https://twitter.com/bobmaerten/status/597347960058454016"&gt;quelques surprises&lt;/a&gt;. Au fond c&amp;#39;est assez transparent, une fois la &lt;a href="http://blog.blackfire.io/how-we-use-docker.html"&gt;configuration correctement install√©e&lt;/a&gt;.&lt;/p&gt;

&lt;h2&gt;Mise en place du conteneur&lt;/h2&gt;

&lt;p&gt;Voila, nous avons une image plus ou moins fonctionelle, reste plus qu&amp;#39;√† la d√©ployer et assurer la persistance des donn√©es.
Pour le d√©ploiement, j&amp;#39;ai √† ma disposition une petite instance d&amp;#39;un serveur Ubuntu chez &lt;a href="https://www.digitalocean.com/?refcode=dd83518f68db"&gt;DigitalOcean&lt;/a&gt; sur lequel un &lt;em&gt;daemon&lt;/em&gt; docker assure le travail, ainsi qu&amp;#39;un &lt;a href="https://github.com/jwilder/nginx-proxy"&gt;conteneur particulier&lt;/a&gt; qui ‚Äú√©coute‚Äù les √©v√©nements du service et qui met en place un reverse-proxy sur le nom du VIRTUAL_HOST pass√© en variable d&amp;#39;environnement du conteneur.&lt;/p&gt;

&lt;p&gt;Pour la persitance des donn√©es on peut soit monter un dossier de l&amp;#39;h√¥te lors du d√©marrage du conteneur avec l&amp;#39;option &lt;code&gt;-v&lt;/code&gt; ou alors cr√©er des &lt;em&gt;data-volumes&lt;/em&gt; et utiliser l&amp;#39;option &lt;code&gt;--volumes-from&lt;/code&gt;. Pour des questions de simplicit√© et puisque je maitrise mon contexte j&amp;#39;utilise la premi√®re solution, mais docker pr√©conise plut√¥t l&amp;#39;usage de conteneur de donn√©es pour des raisons de portabilit√©.&lt;/p&gt;

&lt;p&gt;Voici donc la ligne de commande permettant de lancer le conteneur&amp;nbsp;:&lt;/p&gt;
&lt;pre class="highlight plaintext"&gt;&lt;code&gt;docker run --name comments \
       -e VIRTUAL_HOST='comments.bobmaerten.eu' \
       -e SECRET_KEY_BASE='$(rake secret)' \
       -v /root/containers/comments/db:/usr/src/app/db \
       -v /root/containers/comments/log:/usr/src/app/log \
       --restart=always \
       --detach juvia_app
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;R√©sultats&lt;/h2&gt;

&lt;p&gt;Si tout vas bien, lors du d√©ploiement de cette version du site avec ce billet, le layout devrait afficher la liste des commentaires des billets ainsi qu&amp;#39;un formulaire pour en laisser. Ce sera l&amp;#39;occasion de tester l&amp;#39;application en r√©el et de voir les am√©liorations √† apporter m√™me si j&amp;#39;ai d√©j√† quelques id√©es (localisation, ajout de notifications, etc.).&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Mon nouveau travail, bilan apr√®s un mois</title>
    <link rel="alternate" href="https://bobmaerten.eu/blog/mon-nouveau-travail-bilan-apres-un-mois.html"/>
    <id>https://bobmaerten.eu/blog/mon-nouveau-travail-bilan-apres-un-mois.html</id>
    <published>2015-04-25T15:25:48+02:00</published>
    <updated>2015-11-08T12:29:14+01:00</updated>
    <author>
      <name>Bob Maerten ‚Äî Blog Perso</name>
    </author>
    <content type="html">&lt;p&gt;Pour √™tre tout √† fait honn√™te, j&amp;#39;avais pr√©vu de faire un point une semaine, 15j et 1 mois apr√®s mon changement de travail, mais force est de constater que je suis compl√®tement largu√© sur le timing.&lt;/p&gt;

&lt;p&gt;Il faut dire que le changement f√ªt assez rude. Je n&amp;#39;aurais pas cru que de revenir √† mes premi√®res amours de d√©veloppeur serait aussi difficile&amp;nbsp;! Les journ√©es, voire les semaines passent √† une vitesse&amp;hellip; Bref, ce n&amp;#39;est pas simple, mais √ßa revient un peu √† la fois, et j&amp;#39;apprends plein de choses en plus de d√©couvrir ce nouveau domaine assez m√©connu pour moi qu&amp;#39;est le e-commerce.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;p&gt;Sans entrer dans les d√©tails, je travaille pour un client qui utilise notre solution &lt;em&gt;adhoc&lt;/em&gt; de site de e-commerce, associ√© √† un back-office de gestion commerciale, le tout d√©velopp√© en &lt;a href="http://rubyonrails.org/"&gt;Ruby on Rails&lt;/a&gt; depuis quelques ann√©es et quelques versions majeures de &lt;em&gt;RoR&lt;/em&gt;, donc qui a beaucoup √©volu√© depuis. M√™me sans prendre en compte mon double &lt;em&gt;noobiisme&lt;/em&gt; de sysadmin en r√©mission et du domaine concern√©, rentrer dans le concept de l&amp;#39;application n&amp;#39;est pas simple. Mon boss a eu la bonne id√©e de me coller sur la couverture des tests. C&amp;#39;est un tr√®s bon moyen de comprendre ce qu&amp;#39;est cens√© faire l&amp;#39;appli, tout en me replongeant dans la logique des tests unitaires/fonctionnels. C&amp;#39;est √©galement un excellent moyen d&amp;#39;augmenter la confiance dans les modifications que je peux apporter.&lt;/p&gt;

&lt;p&gt;J&amp;#39;appr√©cie √©galement le flux de travail mis en place. R√©partis √† quatres coins de mon √©cran, un √©diteur de texte, plusieurs &lt;em&gt;shells&lt;/em&gt; au sein d&amp;#39;une session &lt;a href="http://tmux.sourceforge.net/"&gt;tmux&lt;/a&gt; faisant tourner la &lt;em&gt;stack&lt;/em&gt; de l&amp;#39;application, un &lt;a href="https://github.com/guard/guard"&gt;guard&lt;/a&gt; pour valider les tests associ√©s au fichier que je suis en train de modifier, une console pour acc√©der aux donn√©es, l&amp;#39;appli github pour &lt;em&gt;commit&lt;/em&gt;er et &lt;em&gt;push&lt;/em&gt;er mes changements. Une fois le travail pouss√© sur github, les hooks se mettent en marche et d√©clenchent un test global chez &lt;a href="https://codeship.com"&gt;codeship&lt;/a&gt; ainsi qu&amp;#39;une analyse du code chez &lt;a href="https://codeclimate.com"&gt;codeclimate&lt;/a&gt; et je suis notifi√© du r√©sultat dans &lt;a href="https://slack.com"&gt;slack&lt;/a&gt;.  Ces actions s&amp;#39;ex√©cutent √©galement lorsque qu&amp;#39;on fait un &lt;em&gt;Pull Request&lt;/em&gt; et ont la bonne id√©e de s&amp;#39;ins√©rer directement dans les infos de github, ce qui permet d&amp;#39;avoir une confiance accrue dans la fusion de branche, et √ßa franchement c&amp;#39;est top.&lt;/p&gt;

&lt;p&gt;En ce qui concerne l&amp;#39;organisation du travail, j&amp;#39;avais naturellement des appr√©hensions vis √† vis de ma relation au t√©l√©travail, mais finalement elles se sont dissip√©es assez rapidement. Des &lt;em&gt;calls&lt;/em&gt; (&lt;a href="http://www.mumble.com"&gt;mumble&lt;/a&gt;/&lt;a href="https://join.me"&gt;join.me&lt;/a&gt;) r√©guliers avec mon boss et les clients (y compris quand je bloque sur un point), un &lt;a href="https://slack.com"&gt;slack&lt;/a&gt; pour la communication interne, et un compte-rendu du travail effectu√© en fin de journ√©e que j&amp;#39;organise un peu comme je l&amp;#39;entends du moment que le travail est fait. Et √ßa, √ßa change tout&amp;nbsp;! Aller poster un courrier ou chercher un recommand√© √† la poste, prendre une 1/2h pour aller chez le coiffeur ou √† un rendez-vous m√©dical, effectuer une d√©marche administrative pendant les horaires de bureaux, tout cela est possible et accessible.&lt;/p&gt;

&lt;p&gt;Donc me voil√†, presque un mois apr√®s cette reconversion assez inatendue, de retour derri√®re un √©diteur de texte pour transformer des specifications en services concrets, utiles et utilis√©s. Rien que cela est un √©norme gain qui, certes me prends du temps et de l&amp;#39;√©nergie, mais qui m&amp;#39;apporte la satisfaction professionnelle qui me manquait tant. L&amp;#39;effort intellectuel est parfois difficile, tant au niveau du retard √† rattraper sur les √©volutions des outils, des concepts et parfois aussi de l&amp;#39;algorithmique que je n&amp;#39;ai que peu pratiqu√©e ces derni√®res ann√©es, mais en vaut largement la chandelle.&lt;/p&gt;

&lt;p&gt;J&amp;#39;essairai de faire d&amp;#39;autres points prochainement, et je l&amp;#39;esp√®re des billets un peu plus techniques et concr√®ts quand je serai plus √† l&amp;#39;aise. En attendant, je retourne m&amp;#39;impr√©gner de cette &lt;em&gt;codebase&lt;/em&gt; que je ne d√©sesp√®re pas d&amp;#39;appr√©hender globalement tant√¥t.&lt;/p&gt;
</content>
  </entry>
</feed>
